<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Homepage</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%233b82f6' width='100' height='100' rx='20'/><text x='50' y='72' font-size='60' font-family='system-ui,sans-serif' font-weight='bold' fill='white' text-anchor='middle'>H</text></svg>">
    <script>
        // Set page title and favicon based on domain
        (function() {
            const domain = window.location.hostname;
            const letter = domain.charAt(0).toUpperCase();
            document.title = domain;
            document.getElementById('favicon').href =
                `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%233b82f6' width='100' height='100' rx='20'/><text x='50' y='72' font-size='60' font-family='system-ui,sans-serif' font-weight='bold' fill='white' text-anchor='middle'>${letter}</text></svg>`;
        })();
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="app()" x-init="init()" x-cloak>
        <!-- Toast Notification -->
        <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2">
            <span x-text="toast.message"></span>
        </div>
        <!-- PUBLIC LANDING -->
        <template x-if="view === 'public'">
            <div class="flex flex-col items-center justify-center min-h-screen px-4">
                <h1 class="text-6xl font-bold text-blue-400 mb-4" x-text="baseDomain"></h1>
                <p class="text-gray-500 text-sm mb-8">Private services</p>

                <!-- Admin Login -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm">
                    <form @submit.prevent="adminLogin" autocomplete="on">
                        <input type="text" name="username" autocomplete="username" value="admin"
                               class="hidden" aria-hidden="true">
                        <input type="password" x-model="adminPassword" placeholder="Admin password"
                               name="password" autocomplete="current-password"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 mb-3 focus:outline-none focus:border-blue-500">
                        <label class="flex items-center gap-2 text-gray-300 text-sm mb-3">
                            <input type="checkbox" x-model="rememberMe"
                                   class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                            Remember me
                        </label>
                        <div x-show="loginError" class="text-red-400 text-sm mb-3" x-text="loginError" data-testid="error"></div>
                        <button type="submit" data-testid="login-btn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-colors">
                            Login
                        </button>
                    </form>
                </div>
                <footer class="absolute bottom-4 text-center w-full">
                    <a href="https://github.com/nelsonblaha/homepage" target="_blank"
                       class="text-gray-600 hover:text-gray-400 text-sm transition-colors">
                        Powered by Homepage
                    </a>
                </footer>
            </div>
        </template>

        <!-- FRIEND VIEW -->
        <template x-if="view === 'friend'">
            <div class="max-w-4xl mx-auto px-4 py-12">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-blue-300 mb-2">Welcome, <span x-text="friendName"></span></h1>
                    <p class="text-xl text-gray-400" x-text="baseDomain"></p>
                </div>

                <div x-show="friendError" class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded mb-6">
                    <span x-text="friendError"></span>
                </div>

                <!-- Grouped by stack -->
                <template x-for="group in getGroupedServices(friendServices)" :key="group.stack">
                    <div class="mb-8">
                        <!-- Stack header (for stacks with 2+ services, or "Other" for ungrouped) -->
                        <div x-show="group.services.length >= 2 || !group.stack" class="flex items-center gap-2 mb-3">
                            <span class="text-2xl" x-text="getStackIcon(group.stack)"></span>
                            <span class="text-lg font-semibold text-gray-400" x-text="group.stack ? getStackLabel(group.stack) : 'Other'"></span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" data-testid="services-grid">
                            <template x-for="service in group.services" :key="service.id">
                                <div @click="handleServiceClick(service)"
                                     class="bg-gray-800 hover:bg-gray-700 rounded-lg p-6 text-center transition-colors border border-gray-700 hover:border-blue-500 relative cursor-pointer">
                                    <!-- Status indicator icon -->
                                    <template x-if="getServiceIcon(service)">
                                        <span class="absolute top-2 right-2 text-sm"
                                              :class="'text-' + getServiceIcon(service).color"
                                              :title="getServiceIcon(service).title"
                                              x-text="getServiceIcon(service).icon"></span>
                                    </template>
                                    <!-- Jitsi participant badge (for Video Chat service) -->
                                    <span x-show="service.name.toLowerCase().includes('video') && jitsiParticipants > 0"
                                          class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"
                                          x-text="jitsiParticipants" :title="jitsiParticipants + ' in call'"></span>
                                    <div x-show="service.icon" class="text-3xl mb-2" x-text="service.icon"></div>
                                    <div class="font-semibold" x-text="service.name"></div>
                                    <div x-show="service.description" class="text-sm text-gray-400 mt-1" x-text="service.description"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <footer class="text-center mt-12">
                    <a href="https://github.com/nelsonblaha/homepage" target="_blank"
                       class="text-gray-600 hover:text-gray-400 text-sm transition-colors">
                        Powered by Homepage
                    </a>
                </footer>
            </div>
        </template>

        <!-- REQUEST ACCESS -->
        <template x-if="view === 'request-access'">
            <div class="flex flex-col items-center justify-center min-h-screen px-4">
                <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md text-center">
                    <h1 class="text-3xl font-bold text-blue-400 mb-2" x-text="baseDomain"></h1>

                    <template x-if="!requestInfo.friend_name">
                        <div>
                            <p class="text-gray-400 mb-4">You need to visit your friend link first to request access.</p>
                            <a href="/" class="text-blue-400 hover:text-blue-300">Go to homepage</a>
                        </div>
                    </template>

                    <template x-if="requestInfo.friend_name && requestInfo.service">
                        <div>
                            <p class="text-xl text-gray-300 mb-6">
                                Hi <span class="text-blue-300" x-text="requestInfo.friend_name"></span>!
                            </p>

                            <div class="text-5xl mb-4" x-text="requestInfo.service.icon || 'üîí'"></div>
                            <p class="text-gray-400 mb-6">
                                You don't have access to <span class="text-white font-semibold" x-text="requestInfo.service.name"></span>.
                            </p>

                            <template x-if="requestInfo.has_pending_request">
                                <div class="bg-yellow-900/50 border border-yellow-600 text-yellow-200 px-4 py-3 rounded">
                                    Your request is pending approval.
                                </div>
                            </template>

                            <template x-if="!requestInfo.has_pending_request && !requestSubmitted">
                                <button @click="submitAccessRequest"
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded transition-colors">
                                    Request Access
                                </button>
                            </template>

                            <template x-if="requestSubmitted">
                                <div class="bg-green-900/50 border border-green-600 text-green-200 px-4 py-3 rounded">
                                    Request submitted! You'll be notified when approved.
                                </div>
                            </template>

                            <div x-show="requestError" class="mt-4 bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded">
                                <span x-text="requestError"></span>
                            </div>
                        </div>
                    </template>

                    <template x-if="requestInfo.friend_name && !requestInfo.service">
                        <div>
                            <p class="text-gray-400">Service not found.</p>
                            <a href="/" class="text-blue-400 hover:text-blue-300 mt-4 inline-block">Go to homepage</a>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- ADMIN LOGIN -->
        <template x-if="view === 'admin-login'">
            <div class="flex flex-col items-center justify-center min-h-screen">
                <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
                    <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
                    <form @submit.prevent="adminLogin" id="admin-login-form" autocomplete="on">
                        <!-- Hidden username field for password managers -->
                        <input type="text" name="username" autocomplete="username" value="admin"
                               class="hidden" aria-hidden="true">
                        <input type="password" x-model="adminPassword" placeholder="Password"
                               name="password" autocomplete="current-password" id="admin-password"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 mb-4 focus:outline-none focus:border-blue-500">
                        <label class="flex items-center gap-2 text-gray-300 mb-4">
                            <input type="checkbox" x-model="rememberMe"
                                   class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                            Remember me for 30 days
                        </label>
                        <div x-show="loginError" class="text-red-400 text-sm mb-4" x-text="loginError" data-testid="error"></div>
                        <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-colors">
                            Login
                        </button>
                    </form>
                </div>
            </div>
        </template>

        <!-- ADMIN SERVICES (Landing page for logged-in admin) -->
        <template x-if="view === 'admin-services'">
            <div class="max-w-4xl mx-auto px-4 py-12 relative">
                <!-- Admin link in corner -->
                <div class="absolute top-4 right-4 flex items-center gap-4">
                    <a href="/admin" class="text-blue-400 hover:text-blue-300 text-sm font-medium">Admin Panel</a>
                    <button @click="adminLogout" class="text-gray-400 hover:text-white text-sm">Logout</button>
                </div>

                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-blue-400 mb-2" x-text="baseDomain"></h1>
                    <p class="text-xl text-gray-300">All Services</p>
                </div>

                <!-- Grouped by stack -->
                <template x-for="group in getGroupedServices(services)" :key="group.stack">
                    <div class="mb-8">
                        <!-- Stack header (for stacks with 2+ services, or "Other" for ungrouped) -->
                        <div x-show="group.services.length >= 2 || !group.stack" class="flex items-center gap-2 mb-3">
                            <span class="text-2xl" x-text="getStackIcon(group.stack)"></span>
                            <span class="text-lg font-semibold text-gray-400" x-text="group.stack ? getStackLabel(group.stack) : 'Other'"></span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <template x-for="service in group.services" :key="service.id">
                                <div @click="handleServiceClick(service)"
                                   class="bg-gray-800 hover:bg-gray-700 rounded-lg p-6 text-center transition-colors border border-gray-700 hover:border-blue-500 relative cursor-pointer">
                                    <!-- Status indicator icon -->
                                    <template x-if="getServiceIcon(service)">
                                        <span class="absolute top-2 right-2 text-sm"
                                              :class="'text-' + getServiceIcon(service).color"
                                              :title="getServiceIcon(service).title"
                                              x-text="getServiceIcon(service).icon"></span>
                                    </template>
                                    <!-- Jitsi participant badge (for Video Chat service) -->
                                    <span x-show="service.name.toLowerCase().includes('video') && jitsiParticipants > 0"
                                          class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"
                                          x-text="jitsiParticipants" :title="jitsiParticipants + ' in call'"></span>
                                    <div x-show="service.icon" class="text-3xl mb-2" x-text="service.icon"></div>
                                    <div class="font-semibold" x-text="service.name"></div>
                                    <div x-show="service.description" class="text-sm text-gray-400 mt-1" x-text="service.description"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- ADMIN PANEL -->
        <template x-if="view === 'admin'">
            <div class="max-w-6xl mx-auto px-4 py-8">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-blue-400"><span x-text="baseDomain"></span> Admin</h1>
                    <div class="flex items-center gap-4">
                        <a href="/" class="text-blue-400 hover:text-blue-300 text-sm">Services</a>
                        <button @click="adminLogout" class="text-gray-400 hover:text-white" data-testid="logout-btn">Logout</button>
                    </div>
                </div>

                <!-- TABS -->
                <div class="flex justify-around md:justify-start md:space-x-4 mb-6 border-b border-gray-700">
                    <button @click="setAdminTab('friends')" data-testid="tab-friends"
                            :class="adminTab === 'friends' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-400'"
                            class="flex-1 md:flex-none px-2 md:px-4 py-2 -mb-px text-xs md:text-base">
                        <span class="md:hidden">üë•</span>
                        <span class="hidden md:inline">Friends</span>
                    </button>
                    <button @click="setAdminTab('services')" data-testid="tab-services"
                            :class="adminTab === 'services' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-400'"
                            class="flex-1 md:flex-none px-2 md:px-4 py-2 -mb-px text-xs md:text-base">
                        <span class="md:hidden">‚öôÔ∏è</span>
                        <span class="hidden md:inline">Services</span>
                    </button>
                    <button @click="setAdminTab('requests')" data-testid="tab-requests"
                            :class="adminTab === 'requests' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-400'"
                            class="flex-1 md:flex-none px-2 md:px-4 py-2 -mb-px relative text-xs md:text-base">
                        <span class="md:hidden">üì¨</span>
                        <span class="hidden md:inline">Requests</span>
                        <span x-show="accessRequests.length > 0"
                              class="absolute -top-1 -right-0 md:-right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 md:w-5 md:h-5 flex items-center justify-center"
                              x-text="accessRequests.length"></span>
                    </button>
                    <button @click="setAdminTab('activity')" data-testid="tab-activity"
                            :class="adminTab === 'activity' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-400'"
                            class="flex-1 md:flex-none px-2 md:px-4 py-2 -mb-px text-xs md:text-base">
                        <span class="md:hidden">üìä</span>
                        <span class="hidden md:inline">Activity</span>
                    </button>
                    <button @click="setAdminTab('infra')" data-testid="tab-infra"
                            :class="adminTab === 'infra' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-400'"
                            class="flex-1 md:flex-none px-2 md:px-4 py-2 -mb-px relative text-xs md:text-base">
                        <span class="md:hidden">üñ•Ô∏è</span>
                        <span class="hidden md:inline">Infra</span>
                        <span x-show="infraHealth?.summary?.warning > 0 || infraHealth?.summary?.critical > 0"
                              class="absolute -top-1 -right-0 md:-right-1 text-xs rounded-full w-4 h-4 md:w-5 md:h-5 flex items-center justify-center"
                              :class="infraHealth?.summary?.critical > 0 ? 'bg-red-500' : 'bg-yellow-500'"
                              x-text="(infraHealth?.summary?.warning || 0) + (infraHealth?.summary?.critical || 0)"></span>
                    </button>
                </div>

                <!-- FRIENDS TAB -->
                <div x-show="adminTab === 'friends'" data-testid="friends-panel">
                    <!-- Add Friend Form -->
                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Add Friend</h3>
                        <form @submit.prevent="addFriend" class="flex flex-wrap gap-4">
                            <input type="text" x-model="newFriendName" placeholder="Friend's name" data-testid="new-friend-input"
                                   class="flex-1 min-w-48 bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <button type="submit" data-testid="add-friend-btn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded transition-colors">
                                Add
                            </button>
                        </form>
                    </div>

                    <!-- Friends List -->
                    <div class="space-y-3">
                        <template x-for="friend in getSortedFriends()" :key="friend.id">
                            <div class="bg-gray-800 rounded-lg overflow-hidden">
                                <!-- Collapsible Header -->
                                <button @click="expandedFriends[friend.id] = !expandedFriends[friend.id]"
                                        class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-750 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <span x-text="expandedFriends[friend.id] ? '‚ñº' : '‚ñ∂'" class="text-gray-400 text-sm"></span>
                                        <h4 class="text-lg font-semibold" x-text="friend.name"></h4>
                                        <span x-show="friend.last_visit" class="text-sm text-gray-500">
                                            <span x-text="formatDate(friend.last_visit)"></span>
                                            <span class="text-gray-600">(<span x-text="timeAgo(friend.last_visit)"></span>)</span>
                                        </span>
                                        <span x-show="!friend.last_visit" class="text-sm text-gray-600">Never visited</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500" x-text="friend.services.length + ' services'"></span>
                                    </div>
                                </button>

                                <!-- Expanded Content -->
                                <div x-show="expandedFriends[friend.id]" x-transition:enter="transition ease-out duration-200"
                                     x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                                     class="px-4 pb-4 border-t border-gray-700">
                                    <div class="flex justify-between items-start pt-3 mb-3">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <a :href="'/f/' + friend.token" data-testid="friend-link"
                                                   class="text-sm text-gray-400 bg-gray-700 px-2 py-1 rounded hover:text-blue-300"
                                                   x-text="baseDomain + '/f/' + friend.token"></a>
                                                <button @click.stop="copyUrl(friend.token)"
                                                        class="text-blue-400 hover:text-blue-300 text-sm">Copy</button>
                                            </div>
                                        </div>
                                        <button @click.stop="deleteFriend(friend.id)"
                                                class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                    </div>

                                    <div class="border-t border-gray-700 pt-3">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="text-gray-500 text-left">
                                                    <th class="pb-2 font-medium">Service</th>
                                                    <th class="pb-2 font-medium">Stack</th>
                                                    <th class="pb-2 font-medium">Status</th>
                                                    <th class="pb-2 font-medium text-center" title="Whether this service is visible to friends">Visible</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="service in getSortedServicesForFriend(friend)" :key="service.id">
                                                    <tr class="border-t border-gray-700/50" :class="{'opacity-50': !service.visible_to_friends}">
                                                        <td class="py-2">
                                                            <span x-text="service.icon" class="mr-1"></span>
                                                            <span x-text="service.name"></span>
                                                        </td>
                                                        <td class="py-2 text-gray-400" x-text="service.stack || '-'"></td>
                                                        <td class="py-2">
                                                            <!-- Not allowed - show Add link -->
                                                            <template x-if="!hasService(friend, service.id)">
                                                                <button @click.stop="addServiceToFriend(friend, service)"
                                                                        class="text-blue-400 hover:text-blue-300"
                                                                        :disabled="!service.visible_to_friends">
                                                                    + Add
                                                                </button>
                                                            </template>
                                                            <!-- Allowed - show status based on service type -->
                                                            <template x-if="hasService(friend, service.id)">
                                                                <span>
                                                                    <!-- Creating account (loading state) -->
                                                                    <span x-show="creatingAccount[friend.id + '-' + service.id]"
                                                                          class="text-yellow-400">creating account...</span>
                                                                    <!-- Has account (managed service with account) -->
                                                                    <span x-show="!creatingAccount[friend.id + '-' + service.id] && isManagedService(service) && hasAccount(friend, service)"
                                                                          class="text-green-400">has account</span>
                                                                    <!-- Allowed but no account needed or not managed -->
                                                                    <span x-show="!creatingAccount[friend.id + '-' + service.id] && (!isManagedService(service) || !hasAccount(friend, service))"
                                                                          class="text-gray-400">allowed</span>
                                                                    <!-- Remove button -->
                                                                    <button @click.stop="removeServiceFromFriend(friend, service)"
                                                                            class="ml-2 text-red-400 hover:text-red-300 text-xs"
                                                                            x-show="!creatingAccount[friend.id + '-' + service.id]">‚úï</button>
                                                                </span>
                                                            </template>
                                                        </td>
                                                        <td class="py-2 text-center">
                                                            <button @click.stop="toggleServiceVisibility(service)"
                                                                    class="text-lg"
                                                                    :title="service.visible_to_friends ? 'Hide from friends' : 'Show to friends'">
                                                                <span x-show="service.visible_to_friends">üëÅÔ∏è</span>
                                                                <span x-show="!service.visible_to_friends">üö´</span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- REQUESTS TAB -->
                <div x-show="adminTab === 'requests'">
                    <template x-if="accessRequests.length === 0">
                        <div class="bg-gray-800 rounded-lg p-6 text-center text-gray-400">
                            No pending access requests.
                        </div>
                    </template>

                    <div class="space-y-4">
                        <template x-for="req in accessRequests" :key="req.id">
                            <div class="bg-gray-800 rounded-lg p-6 flex items-center justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl" x-text="req.icon || 'üìù'"></span>
                                        <div>
                                            <span class="font-semibold text-white" x-text="req.friend_name"></span>
                                            <span class="text-gray-400"> wants access to </span>
                                            <span class="font-semibold text-blue-400" x-text="req.service_name"></span>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="formatDate(req.requested_at)"></div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="approveRequest(req.id)"
                                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                        Approve
                                    </button>
                                    <button @click="denyRequest(req.id)"
                                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                                        Deny
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- ACTIVITY TAB -->
                <div x-show="adminTab === 'activity'" data-testid="activity-panel">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-blue-400" x-text="activityStats.page_views || 0"></div>
                            <div class="text-sm text-gray-400">Page Views</div>
                            <div class="text-xs text-gray-500">Last <span x-text="activityStats.period_days || 7"></span> days</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-green-400" x-text="activityStats.service_clicks || 0"></div>
                            <div class="text-sm text-gray-400">Service Clicks</div>
                            <div class="text-xs text-gray-500">Last <span x-text="activityStats.period_days || 7"></span> days</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-purple-400" x-text="activityStats.active_friends || 0"></div>
                            <div class="text-sm text-gray-400">Active Friends</div>
                            <div class="text-xs text-gray-500">Last <span x-text="activityStats.period_days || 7"></span> days</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-400" x-text="friends.length || 0"></div>
                            <div class="text-sm text-gray-400">Total Friends</div>
                            <div class="text-xs text-gray-500">All time</div>
                        </div>
                    </div>

                    <!-- Top Services & Friends -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-gray-300">Top Services</h3>
                            <template x-if="activityStats.top_services && activityStats.top_services.length > 0">
                                <div class="space-y-2">
                                    <template x-for="svc in activityStats.top_services" :key="svc.name">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300" x-text="svc.name"></span>
                                            <span class="text-blue-400 font-semibold" x-text="svc.clicks + ' clicks'"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!activityStats.top_services || activityStats.top_services.length === 0">
                                <div class="text-gray-500 text-sm">No activity yet</div>
                            </template>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-gray-300">Most Active Friends</h3>
                            <template x-if="activityStats.top_friends && activityStats.top_friends.length > 0">
                                <div class="space-y-2">
                                    <template x-for="friend in activityStats.top_friends" :key="friend.name">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300" x-text="friend.name"></span>
                                            <span class="text-green-400 font-semibold" x-text="friend.visits + ' visits'"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!activityStats.top_friends || activityStats.top_friends.length === 0">
                                <div class="text-gray-500 text-sm">No activity yet</div>
                            </template>
                        </div>
                    </div>

                    <!-- Recent Activity Log -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-300">Recent Activity</h3>
                            <button @click="loadActivity()" class="text-sm text-blue-400 hover:text-blue-300">Refresh</button>
                        </div>
                        <template x-if="activityLog.length > 0">
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                <template x-for="entry in activityLog" :key="entry.id">
                                    <div class="flex items-center gap-3 py-2 border-b border-gray-700 last:border-0">
                                        <span class="text-lg" x-text="getActivityIcon(entry.action)"></span>
                                        <div class="flex-1">
                                            <span class="text-gray-300" x-text="entry.friend_name || 'Unknown'"></span>
                                            <span class="text-gray-500" x-text="getActivityVerb(entry.action)"></span>
                                            <span x-show="entry.service_name" class="text-blue-400" x-text="entry.service_name"></span>
                                        </div>
                                        <div class="text-xs text-gray-500" x-text="timeAgo(entry.created_at)"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="activityLog.length === 0">
                            <div class="text-gray-500 text-center py-8">No activity recorded yet</div>
                        </template>
                    </div>
                </div>

                <!-- INFRA TAB -->
                <div x-show="adminTab === 'infra'" data-testid="infra-panel">
                    <!-- Loading State -->
                    <template x-if="infraHealthLoading">
                        <div class="bg-gray-800 rounded-lg mb-4">
                            <div class="px-4 py-8 text-center text-gray-500">
                                <div class="flex items-center justify-center gap-2 mb-2">
                                    <span class="text-blue-400 text-xl animate-pulse">‚óè</span>
                                    <span class="text-blue-400 text-xl animate-pulse" style="animation-delay: 0.2s">‚óè</span>
                                    <span class="text-blue-400 text-xl animate-pulse" style="animation-delay: 0.4s">‚óè</span>
                                </div>
                                <div>Loading health checks...</div>
                            </div>
                        </div>
                    </template>

                    <!-- Issues (Critical, Warning, Info) -->
                    <template x-if="!infraHealthLoading">
                        <div class="bg-gray-800 rounded-lg divide-y divide-gray-700 mb-4">
                            <template x-for="check in getInfraIssues()" :key="check.check_id">
                                <div class="px-3 py-3 md:px-4">
                                    <div class="flex items-start gap-2 md:gap-3 mb-1">
                                        <span :class="{
                                            'text-blue-400': check.severity === 'info',
                                            'text-yellow-400': check.severity === 'warning',
                                            'text-red-400': check.severity === 'critical'
                                        }" class="flex-shrink-0" x-text="check.severity === 'warning' ? '‚ö†' : check.severity === 'critical' ? '‚úó' : '‚Ñπ'"></span>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-sm md:text-base" x-text="check.name"></div>
                                            <div class="text-xs md:text-sm text-gray-400 mt-0.5" x-text="check.message"></div>
                                            <div class="text-xs text-gray-500 mt-0.5" x-text="'(' + check.source + ')'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <template x-if="getInfraIssues().length === 0">
                                <div class="px-4 py-6 text-center text-gray-500">
                                    <div class="text-green-400 text-2xl mb-2">‚úì</div>
                                    <div>All systems operational</div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- OK Checks (Collapsed by default) -->
                    <div class="bg-gray-800 rounded-lg mb-4">
                        <button @click="showOkChecks = !showOkChecks"
                                class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-750 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="text-green-400">‚óè</span>
                                <span class="font-medium">OK Checks</span>
                                <span class="text-gray-500 text-sm" x-text="'(' + getInfraOkCount() + ')'"></span>
                            </div>
                            <span x-text="showOkChecks ? '‚ñº' : '‚ñ∂'" class="text-gray-500"></span>
                        </button>
                        <div x-show="showOkChecks" class="divide-y divide-gray-700">
                            <template x-for="check in getInfraOkChecks()" :key="check.check_id">
                                <div class="px-3 py-3 md:px-4">
                                    <div class="flex items-start gap-2 md:gap-3 mb-1">
                                        <span class="text-green-400 flex-shrink-0">‚óè</span>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-sm md:text-base" x-text="check.name"></div>
                                            <div class="text-xs md:text-sm text-gray-400 mt-0.5" x-text="check.message"></div>
                                            <div class="text-xs text-gray-500 mt-0.5" x-text="'(' + check.source + ')'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Refresh button -->
                    <div class="mt-6 text-center">
                        <button @click="refreshInfraHealth"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded transition-colors">
                            Refresh Health Checks
                        </button>
                    </div>

                    <!-- Disk Usage Section -->
                    <div class="bg-gray-800 rounded-lg p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-blue-300">Disk Usage</h3>
                            <button @click="loadDiskUsage()" class="text-gray-400 hover:text-blue-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>

                        <template x-if="diskUsage.loading">
                            <div class="text-center py-8 text-gray-400">
                                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-400 mb-2"></div>
                                <p class="text-sm">Loading disk information...</p>
                            </div>
                        </template>

                        <template x-if="diskUsage.error">
                            <div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded">
                                <span x-text="diskUsage.error"></span>
                            </div>
                        </template>

                        <template x-if="!diskUsage.loading && !diskUsage.error && diskUsage.disks.length > 0">
                            <div>
                                <p class="text-xs text-gray-400 mb-4">
                                    Reference: Largest disk = <span class="font-semibold text-white" x-text="diskUsage.maxHuman"></span> (100% bar width)
                                </p>

                                <div class="space-y-3">
                                    <template x-for="disk in diskUsage.disks" :key="disk.mount">
                                        <div class="space-y-1">
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="font-semibold text-gray-300" x-text="disk.label"></span>
                                                <span class="text-gray-500" x-text="disk.mount"></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 h-5 bg-gray-900 rounded-sm overflow-hidden flex">
                                                    <div :style="`width: ${(disk.used_bytes / diskUsage.maxBytes) * 100}%`"
                                                         :class="{
                                                             'bg-green-600': disk.pct <= 60,
                                                             'bg-yellow-500': disk.pct > 60 && disk.pct <= 80,
                                                             'bg-red-600': disk.pct > 80
                                                         }"
                                                         class="h-full flex items-center justify-center">
                                                    </div>
                                                    <div :style="`width: ${(disk.avail_bytes / diskUsage.maxBytes) * 100}%`"
                                                         class="h-full bg-cyan-900/30">
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-3 text-xs w-80">
                                                    <span :class="{
                                                        'text-green-400': disk.pct <= 60,
                                                        'text-yellow-400': disk.pct > 60 && disk.pct <= 80,
                                                        'text-red-400': disk.pct > 80
                                                    }" class="font-semibold w-10 text-right" x-text="disk.pct + '%'"></span>
                                                    <span class="text-gray-500">Used:</span>
                                                    <span class="text-white w-14 text-right" x-text="disk.used"></span>
                                                    <span class="text-gray-500">Avail:</span>
                                                    <span class="text-white w-14 text-right" x-text="disk.avail"></span>
                                                    <span class="text-gray-500">Total:</span>
                                                    <span class="text-white w-14 text-right" x-text="disk.size"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-500">
                                    <span class="font-semibold">Legend:</span>
                                    <span class="ml-3 text-green-400">‚ñ†</span> <span>Healthy (&lt;60%)</span>
                                    <span class="ml-3 text-yellow-400">‚ñ†</span> <span>Warning (60-80%)</span>
                                    <span class="ml-3 text-red-400">‚ñ†</span> <span>Critical (&gt;80%)</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- SERVICES TAB -->
                <div x-show="adminTab === 'services'" x-data="{ expandedServices: {}, integrationStatus: {} }" x-init="loadIntegrationStatus()" data-testid="services-panel">
                    <!-- Services List (grouped by stack) -->
                    <template x-for="group in getGroupedServices(services)" :key="group.stack || 'other'">
                        <div class="mb-6">
                            <!-- Stack Header -->
                            <div class="flex items-center gap-2 mb-3 px-2">
                                <span class="text-xl" x-text="getStackIcon(group.stack)"></span>
                                <span class="text-lg font-semibold text-gray-400" x-text="group.stack ? getStackLabel(group.stack) : 'Other'"></span>
                                <span class="text-sm text-gray-500">(<span x-text="group.services.length"></span>)</span>
                            </div>

                            <!-- Services in Stack -->
                            <div class="space-y-2">
                                <template x-for="service in group.services" :key="service.id">
                                    <div class="bg-gray-800 rounded-lg overflow-hidden">
                                        <!-- Collapsible Header -->
                                        <button @click="expandedServices[service.id] = !expandedServices[service.id]"
                                                class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-750 transition-colors">
                                            <div class="flex items-center gap-3">
                                                <span x-text="expandedServices[service.id] ? '‚ñº' : '‚ñ∂'" class="text-gray-400 text-sm"></span>
                                                <span class="text-xl" x-text="service.icon || 'üì¶'"></span>
                                                <span class="font-semibold" x-text="service.name"></span>
                                                <span x-show="service.is_default" class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded">default</span>
                                                <!-- Integration badge -->
                                                <span x-show="isManagedService(service)"
                                                      :class="integrationStatus[service.name.toLowerCase()]?.connected ? 'text-green-400' : 'text-gray-500'"
                                                      class="text-xs">
                                                    <span x-show="integrationStatus[service.name.toLowerCase()]?.connected">‚óè connected</span>
                                                    <span x-show="!integrationStatus[service.name.toLowerCase()]?.connected">‚óã not connected</span>
                                                </span>
                                                <!-- CI status badge -->
                                                <a x-show="service.github_repo && ciStatus[service.id]"
                                                   :href="ciStatus[service.id]?.url || `https://github.com/${service.github_repo}/actions`"
                                                   target="_blank"
                                                   :class="getCIBadgeClass(service.id)"
                                                   class="text-xs px-2 py-0.5 rounded font-mono"
                                                   :title="`CI: ${ciStatus[service.id]?.conclusion || ciStatus[service.id]?.status || 'unknown'}`">
                                                    CI <span x-text="getCIBadgeText(service.id)"></span>
                                                </a>
                                                <!-- Auth status indicator -->
                                                <span x-show="getAuthStatusInfo(service)"
                                                      :title="getAuthStatusInfo(service)?.title"
                                                      class="text-sm"
                                                      x-text="getAuthStatusInfo(service)?.icons"></span>
                                            </div>
                                            <div class="flex items-center gap-3 text-sm text-gray-400">
                                                <span x-text="service.subdomain ? service.subdomain + '.' : ''"></span>
                                            </div>
                                        </button>

                                        <!-- Expanded Content -->
                                        <div x-show="expandedServices[service.id]" x-transition:enter="transition ease-out duration-200"
                                             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                                             class="px-4 pb-4 border-t border-gray-700">
                                            <div class="pt-3 space-y-4">
                                                <!-- URL & Description Row -->
                                                <div class="flex flex-wrap gap-4 text-sm">
                                                    <div>
                                                        <span class="text-gray-500">URL:</span>
                                                        <a :href="service.url" target="_blank"
                                                           class="text-blue-400 hover:text-blue-300 ml-1"
                                                           x-text="service.subdomain ? service.subdomain + '.' + baseDomain : service.url"></a>
                                                    </div>
                                                    <div x-show="service.description">
                                                        <span class="text-gray-500">Description:</span>
                                                        <span class="text-gray-300 ml-1" x-text="service.description"></span>
                                                    </div>
                                                </div>

                                                <!-- Authentication & Security Overview -->
                                                <div class="bg-gray-700/50 rounded p-3">
                                                    <div class="text-sm font-medium text-gray-300 mb-2">üîê Authentication & Security</div>
                                                    <div class="text-sm text-gray-300 space-y-2" x-html="getSecurityDescription(service)"></div>
                                                </div>

                                                <!-- Integration Status (for managed services) -->
                                                <div x-show="isManagedService(service)" class="bg-gray-700/50 rounded p-3">
                                                    <div class="text-sm font-medium text-gray-300 mb-2">Integration</div>
                                                    <div class="flex flex-wrap gap-4 text-sm">
                                                        <div>
                                                            <span class="text-gray-500">Status:</span>
                                                            <span :class="integrationStatus[service.name.toLowerCase()]?.connected ? 'text-green-400' : 'text-red-400'" class="ml-1"
                                                                  x-text="integrationStatus[service.name.toLowerCase()]?.connected ? 'Connected' : 'Not Connected'"></span>
                                                        </div>
                                                        <div>
                                                            <span class="text-gray-500">Accounts:</span>
                                                            <span class="text-gray-300 ml-1" x-text="integrationStatus[service.name.toLowerCase()]?.accounts_created || 0"></span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Actions -->
                                                <div class="flex flex-wrap gap-2 pt-2">
                                                    <button @click="toggleServiceDefault(service)"
                                                            :class="service.is_default ? 'text-yellow-400 hover:text-yellow-300' : 'text-green-400 hover:text-green-300'"
                                                            class="text-sm px-3 py-1 bg-gray-700 rounded hover:bg-gray-600"
                                                            x-text="service.is_default ? 'Remove Default' : 'Make Default'"></button>
                                                    <button x-show="supportsAuthUrl(service)" @click="copyPreauthUrl(service.id)"
                                                            class="text-sm px-3 py-1 bg-gray-700 rounded text-blue-400 hover:text-blue-300 hover:bg-gray-600">Copy Auth URL</button>
                                                    <button @click="startEditService(service)"
                                                            class="text-sm px-3 py-1 bg-gray-700 rounded text-gray-300 hover:text-white hover:bg-gray-600">Edit</button>
                                                    <button @click="deleteService(service.id)"
                                                            class="text-sm px-3 py-1 bg-gray-700 rounded text-red-400 hover:text-red-300 hover:bg-gray-600">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Add Service Form -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Add Service</h3>
                        <form @submit.prevent="addService" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" x-model="newService.name" placeholder="Service name" required
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="url" x-model="newService.url" placeholder="URL (https://...)" required
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="text" x-model="newService.icon" placeholder="Icon (emoji)"
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="text" x-model="newService.description" placeholder="Description"
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="text" x-model="newService.subdomain" placeholder="Subdomain (e.g. ombi)"
                                   title="For nginx forward auth: set subdomain here and configure nginx location_block for subdomain.yourdomain.com with auth_request to /api/auth/forward-auth"
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="text" x-model="newService.github_repo" placeholder="GitHub repo (e.g. nelsonblaha/homepage)"
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <input type="text" x-model="newService.quick_join_params" placeholder='Quick-join params JSON (e.g. {"session":"blaha.io"})'
                                   class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                            <label class="flex items-center gap-2 text-gray-300">
                                <input type="checkbox" x-model="newService.is_default"
                                       class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                Default for new friends
                            </label>
                            <button type="submit"
                                    class="md:col-span-2 lg:col-span-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded transition-colors">
                                Add Service
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </template>

        <!-- Credentials Modal -->
        <div x-show="showCredentials" x-cloak
             class="fixed inset-0 bg-black/70 flex items-center justify-center z-50"
             @click.self="showCredentials = false">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border border-gray-700">
                <div class="text-center mb-6">
                    <span class="text-4xl" x-text="credentialsService?.icon || 'üîê'"></span>
                    <h3 class="text-xl font-bold mt-2" x-text="credentialsService?.name"></h3>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-400">Username</label>
                        <div class="flex items-center gap-2 mt-1">
                            <code class="flex-1 bg-gray-700 px-3 py-2 rounded text-blue-300 font-mono" x-text="friendCredentials.username"></code>
                            <button @click="copyToClipboard(friendCredentials.username)"
                                    class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Copy</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm text-gray-400">Password</label>
                        <div class="flex items-center gap-2 mt-1">
                            <code class="flex-1 bg-gray-700 px-3 py-2 rounded text-green-300 font-mono" x-text="friendCredentials.password"></code>
                            <button @click="copyToClipboard(friendCredentials.password)"
                                    class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Copy</button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <a :href="getDirectServiceUrl(credentialsService)"
                       target="_blank"
                       class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-center transition-colors">
                        Go to <span x-text="credentialsService?.name"></span>
                    </a>
                    <button @click="showCredentials = false"
                            class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Service Modal -->
        <div x-show="editService" x-cloak
             class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
             @click.self="cancelEditService()">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-semibold mb-4">Edit Service</h3>
                <form @submit.prevent="saveEditService()" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" x-model="editService.name" required
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">URL</label>
                        <input type="url" x-model="editService.url" required
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Icon (emoji)</label>
                            <input type="text" x-model="editService.icon"
                                   class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                            <input type="text" x-model="editService.subdomain" placeholder="e.g. ombi"
                                   title="For nginx forward auth: set subdomain here and configure nginx location_block for subdomain.yourdomain.com with auth_request to /api/auth/forward-auth"
                                   class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Description</label>
                        <input type="text" x-model="editService.description"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Stack</label>
                            <select x-model="editService.stack"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="">None</option>
                                <option value="media">Media</option>
                                <option value="social">Social</option>
                                <option value="infra">Infrastructure</option>
                                <option value="priorities">Priorities</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Auth Type</label>
                            <select x-model="editService.auth_type"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="none">None</option>
                                <option value="basic">Basic Auth</option>
                                <option value="forward-auth">Forward Auth</option>
                                <option value="jellyfin">Jellyfin</option>
                                <option value="ombi">Ombi</option>
                                <option value="overseerr">Overseerr</option>
                                <option value="nextcloud">Nextcloud</option>
                                <option value="mattermost">Mattermost</option>
                                <option value="open">Open (no auth)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">GitHub Repo (for CI status)</label>
                        <input type="text" x-model="editService.github_repo" placeholder="e.g. nelsonblaha/homepage"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" x-model="editService.is_default" id="edit-is-default"
                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                        <label for="edit-is-default" class="text-gray-300">Default for new friends</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-colors">
                            Save
                        </button>
                        <button type="button" @click="cancelEditService()"
                                class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                view: 'public',
                adminTab: 'friends',

                // Admin state
                adminPassword: '',
                rememberMe: true,
                loginError: '',
                services: [],
                friends: [],
                accessRequests: [],
                newFriendName: '',
                newService: { name: '', url: '', icon: '', description: '', subdomain: '', is_default: false, github_repo: '', quick_join_params: '' },
                ciStatus: {},
                plexStatus: { connected: false, username: '', error: '' },
                ombiStatus: { connected: false, error: '' },
                jellyfinStatus: { connected: false, serverName: '', error: '' },
                nextcloudStatus: { connected: false, error: '' },
                overseerrStatus: { connected: false, error: '' },
                jitsiParticipants: 0,
                infraHealth: null,
                infraHealthLoading: true,
                expandedInfra: {},
                showOkChecks: false,
                diskUsage: { loading: false, error: '', disks: [], maxBytes: 0, maxHuman: '' },
                editingServiceId: null,
                editingDescription: '',
                editingNameId: null,
                editingName: '',
                editService: null,  // Full service edit modal
                expandedFriends: {},
                creatingAccount: {},  // Track loading state for account creation
                toast: { show: false, message: '' },

                // WebSocket state
                ws: null,
                wsReconnectTimer: null,
                serviceStatuses: {},  // {service_id: {health: 'up'|'down'|'auth_required'}}
                provisioningStatuses: {},  // {friend_id:service: {status: 'provisioning'|'ready'|'failed'}}

                // Activity tracking
                activityStats: {},
                activityLog: [],

                // Base domain (derived from current hostname)
                baseDomain: window.location.hostname,

                // Friend state
                friendId: null,
                friendName: '',
                friendServices: [],
                friendError: '',
                showCredentials: false,
                credentialsService: null,
                friendCredentials: { username: '', password: '' },
                friendToken: '',

                // Request access state
                requestInfo: { service: null, friend_name: null, has_pending_request: false },
                requestSubmitted: false,
                requestError: '',
                requestService: '',

                async init() {
                    const path = window.location.pathname;
                    const params = new URLSearchParams(window.location.search);

                    if (path === '/admin' || path.startsWith('/admin/')) {
                        const resp = await fetch('/api/admin/verify');
                        const data = await resp.json();
                        if (data.authenticated) {
                            this.view = 'admin';
                            await this.loadAdminData();
                            // Set tab from URL path (e.g., /admin/services -> services)
                            const tabFromUrl = path.split('/admin/')[1];
                            if (tabFromUrl && ['services', 'requests', 'activity'].includes(tabFromUrl)) {
                                this.adminTab = tabFromUrl;
                                if (tabFromUrl === 'activity') {
                                    this.loadActivity();
                                }
                            }
                        } else {
                            this.view = 'admin-login';
                        }
                    } else if (path === '/request-access') {
                        this.requestService = params.get('service') || '';
                        await this.loadRequestAccessInfo();
                        this.view = 'request-access';
                    } else if (path.startsWith('/f/')) {
                        const token = path.split('/f/')[1];
                        await this.loadFriendView(token);
                    } else {
                        // Check if admin is logged in - show services grid at root
                        const resp = await fetch('/api/admin/verify');
                        const data = await resp.json();
                        if (data.authenticated) {
                            this.view = 'admin-services';
                            await this.loadServices();
                        } else {
                            this.view = 'public';
                        }
                    }

                    // Connect WebSocket for real-time updates
                    this.connectWebSocket();

                    // Fallback polling for CI status (every 60 seconds) - WebSocket doesn't handle this yet
                    setInterval(() => {
                        if (this.view === 'admin' || this.view === 'admin-services') {
                            this.loadCIStatus();
                        }
                    }, 60000);

                    // Handle browser back/forward for admin tabs
                    window.addEventListener('popstate', (event) => {
                        if (event.state?.tab) {
                            this.adminTab = event.state.tab;
                            if (event.state.tab === 'activity') {
                                this.loadActivity();
                            }
                        } else {
                            // Parse tab from URL if no state
                            const currentPath = window.location.pathname;
                            if (currentPath.startsWith('/admin/')) {
                                const tabFromUrl = currentPath.split('/admin/')[1];
                                if (['services', 'requests', 'activity'].includes(tabFromUrl)) {
                                    this.adminTab = tabFromUrl;
                                }
                            } else if (currentPath === '/admin') {
                                this.adminTab = 'friends';
                            }
                        }
                    });
                },

                setAdminTab(tab) {
                    this.adminTab = tab;
                    // Update URL without reload
                    const newPath = tab === 'friends' ? '/admin' : `/admin/${tab}`;
                    history.pushState({tab}, '', newPath);
                    // Load data when switching to specific tabs
                    if (tab === 'activity') {
                        this.loadActivity();
                    } else if (tab === 'infra') {
                        this.loadDiskUsage();
                    }
                    // Infra health now loads at page init, not tab switch
                },

                async fetchJitsiParticipants() {
                    try {
                        const resp = await fetch('/api/jitsi/participants');
                        if (resp.ok) {
                            const data = await resp.json();
                            this.jitsiParticipants = data.count || 0;
                        }
                    } catch (e) {
                        console.error('Failed to fetch Jitsi participants:', e);
                    }
                },

                connectWebSocket() {
                    if (this.ws) {
                        this.ws.close();
                    }
                    if (this.wsReconnectTimer) {
                        clearTimeout(this.wsReconnectTimer);
                        this.wsReconnectTimer = null;
                    }

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws${this.friendToken ? '?token=' + this.friendToken : ''}`;

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            this.handleWebSocketMessage(msg);
                        } catch (e) {
                            console.error('Failed to parse WebSocket message:', e);
                        }
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocket closed, reconnecting in 5s...');
                        this.wsReconnectTimer = setTimeout(() => this.connectWebSocket(), 5000);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                handleWebSocketMessage(msg) {
                    switch (msg.type) {
                        case 'service_status':
                            this.serviceStatuses[msg.service_id] = { health: msg.health };
                            break;
                        case 'account_status':
                            const key = `${msg.friend_id}:${msg.service}`;
                            if (msg.status === 'ready' || msg.status === 'failed') {
                                delete this.provisioningStatuses[key];
                            } else {
                                this.provisioningStatuses[key] = { status: msg.status };
                            }
                            break;
                        case 'jitsi_update':
                            this.jitsiParticipants = msg.participants;
                            break;
                        case 'infra_health':
                            this.infraHealth = msg;
                            break;
                        case 'infra_health_changes':
                            this.handleInfraHealthChanges(msg);
                            break;
                        case 'activity':
                            // Prepend new activity to the log
                            if (this.activityLog) {
                                this.activityLog.unshift(msg.entry);
                                // Keep only last 50
                                if (this.activityLog.length > 50) {
                                    this.activityLog.pop();
                                }
                            }
                            break;
                    }
                },

                async adminLogin() {
                    this.loginError = '';
                    try {
                        const resp = await fetch('/api/admin/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.adminPassword, remember: this.rememberMe })
                        });
                        if (resp.ok) {
                            // Redirect to services grid (root)
                            window.location.href = '/';
                        } else {
                            this.loginError = 'Invalid password';
                        }
                    } catch (e) {
                        this.loginError = 'Login failed';
                    }
                },

                async adminLogout() {
                    await fetch('/api/admin/logout', { method: 'POST' });
                    this.view = 'admin-login';
                    this.adminPassword = '';
                },

                async loadServices() {
                    const resp = await fetch('/api/services');
                    this.services = await resp.json();
                },

                async loadAdminData() {
                    const [servicesResp, friendsResp, requestsResp] = await Promise.all([
                        fetch('/api/services'),
                        fetch('/api/friends'),
                        fetch('/api/access-requests')
                    ]);
                    this.services = await servicesResp.json();
                    this.friends = await friendsResp.json();
                    this.accessRequests = await requestsResp.json();
                    await this.checkAllStatus();

                    // Load infra health in background
                    this.refreshInfraHealth();
                },

                async loadActivity() {
                    try {
                        const [statsResp, logResp] = await Promise.all([
                            fetch('/api/activity/stats'),
                            fetch('/api/activity?limit=50')
                        ]);
                        if (statsResp.ok) {
                            this.activityStats = await statsResp.json();
                        }
                        if (logResp.ok) {
                            this.activityLog = await logResp.json();
                        }
                    } catch (e) {
                        console.error('Failed to load activity:', e);
                    }
                },

                getActivityIcon(action) {
                    const icons = {
                        'page_view': 'üëÅÔ∏è',
                        'service_click': 'üîó',
                        'auth_login': 'üîê',
                        'credential_view': 'üîë'
                    };
                    return icons[action] || 'üìù';
                },

                getActivityVerb(action) {
                    const verbs = {
                        'page_view': 'visited homepage',
                        'service_click': 'clicked',
                        'auth_login': 'logged in',
                        'credential_view': 'viewed credentials for'
                    };
                    return verbs[action] || action;
                },

                // Infra health helpers
                getContainerIssueCount(checks) {
                    return checks.filter(c => c.severity === 'warning' || c.severity === 'critical').length;
                },

                hasContainerCritical(checks) {
                    return checks.some(c => c.severity === 'critical');
                },

                getSortedInfraChecks() {
                    // Combine infrastructure and container checks into one sorted list
                    const allChecks = [];

                    // Add infrastructure checks
                    if (this.infraHealth?.infra) {
                        this.infraHealth.infra.forEach(check => {
                            allChecks.push({ ...check, source: 'infrastructure' });
                        });
                    }

                    // Add container checks
                    if (this.infraHealth?.containers) {
                        Object.entries(this.infraHealth.containers).forEach(([container, checks]) => {
                            checks.forEach(check => {
                                allChecks.push({ ...check, source: container });
                            });
                        });
                    }

                    // Sort by severity: critical (red) ‚Üí warning (yellow) ‚Üí info (blue) ‚Üí ok (green)
                    const severityOrder = { 'critical': 0, 'warning': 1, 'info': 2, 'ok': 3 };
                    return allChecks.sort((a, b) => {
                        const orderA = severityOrder[a.severity] ?? 99;
                        const orderB = severityOrder[b.severity] ?? 99;
                        if (orderA !== orderB) {
                            return orderA - orderB;
                        }
                        // Secondary sort by name
                        return (a.name || '').localeCompare(b.name || '');
                    });
                },

                getInfraIssues() {
                    // Get only non-OK checks (critical, warning, info)
                    return this.getSortedInfraChecks().filter(c => c.severity !== 'ok');
                },

                getInfraOkChecks() {
                    // Get only OK checks (lazy loaded when expanded)
                    if (!this.showOkChecks) {
                        return []; // Don't process OK checks until user expands
                    }
                    return this.getSortedInfraChecks().filter(c => c.severity === 'ok');
                },

                getInfraOkCount() {
                    // Count OK checks without loading them
                    let count = 0;
                    if (this.infraHealth?.infra) {
                        count += this.infraHealth.infra.filter(c => c.severity === 'ok').length;
                    }
                    if (this.infraHealth?.containers) {
                        Object.values(this.infraHealth.containers).forEach(checks => {
                            count += checks.filter(c => c.severity === 'ok').length;
                        });
                    }
                    return count;
                },

                handleInfraHealthChanges(msg) {
                    // Handle incremental health check updates from WebSocket
                    if (!this.infraHealth) {
                        // If we don't have initial data yet, initialize with empty structure
                        this.infraHealth = {
                            summary: msg.summary || {},
                            infra: [],
                            containers: {}
                        };
                    }

                    // Clear loading state when we receive data
                    this.infraHealthLoading = false;

                    // Update summary counts
                    if (msg.summary) {
                        this.infraHealth.summary = msg.summary;
                    }

                    // Process each changed check
                    const changes = msg.changes || [];
                    changes.forEach(change => {
                        const isInfra = !change.container_name;

                        if (isInfra) {
                            // Infrastructure check (no container)
                            const infraIndex = this.infraHealth.infra.findIndex(
                                c => c.check_id === change.check_id
                            );

                            if (infraIndex >= 0) {
                                // Update existing
                                this.infraHealth.infra[infraIndex] = change;
                            } else {
                                // Add new
                                this.infraHealth.infra.push(change);
                            }
                        } else {
                            // Container-specific check
                            const containerName = change.container_name;
                            if (!this.infraHealth.containers[containerName]) {
                                this.infraHealth.containers[containerName] = [];
                            }

                            const checkIndex = this.infraHealth.containers[containerName].findIndex(
                                c => c.check_id === change.check_id
                            );

                            if (checkIndex >= 0) {
                                // Update existing
                                this.infraHealth.containers[containerName][checkIndex] = change;
                            } else {
                                // Add new
                                this.infraHealth.containers[containerName].push(change);
                            }
                        }

                        // Log notable changes to console (optional, for debugging)
                        if (change.severity === 'warning' || change.severity === 'critical') {
                            console.log(`üö® Health check ${change.changed}: ${change.name} - ${change.message}`);
                        }
                    });

                    // Force Alpine.js reactivity update by creating new object
                    this.infraHealth = { ...this.infraHealth };
                },

                async refreshInfraHealth() {
                    try {
                        // Trigger refresh first
                        await fetch('/api/health/refresh', { method: 'POST' });

                        // Then fetch the formatted data
                        const [statusResp, infraResp, containersResp] = await Promise.all([
                            fetch('/api/health/status'),
                            fetch('/api/health/infra'),
                            fetch('/api/health/containers')
                        ]);

                        if (statusResp.ok && infraResp.ok && containersResp.ok) {
                            const status = await statusResp.json();
                            const infraData = await infraResp.json();
                            const containersData = await containersResp.json();

                            this.infraHealth = {
                                summary: status.summary,
                                infra: infraData.infra || [],
                                containers: containersData.containers || {}
                            };
                        }
                    } catch (e) {
                        console.error('Failed to refresh infra health:', e);
                    } finally {
                        // Clear loading state
                        this.infraHealthLoading = false;
                    }
                },

                async loadDiskUsage() {
                    this.diskUsage.loading = true;
                    this.diskUsage.error = '';
                    try {
                        const resp = await fetch('/api/infra/disks');
                        if (!resp.ok) {
                            if (resp.status === 401 || resp.status === 403) {
                                this.diskUsage.error = 'Authentication required';
                            } else {
                                this.diskUsage.error = `Failed to load disk info (${resp.status})`;
                            }
                            return;
                        }
                        const data = await resp.json();
                        this.diskUsage.disks = data.disks;
                        this.diskUsage.maxBytes = data.max_bytes;
                        this.diskUsage.maxHuman = data.max_human;
                    } catch (e) {
                        this.diskUsage.error = `Failed to load disk info: ${e.message}`;
                        console.error('Failed to load disk usage:', e);
                    } finally {
                        this.diskUsage.loading = false;
                    }
                },

                async checkAllStatus() {
                    await Promise.all([
                        this.checkPlexStatus(),
                        this.checkOmbiStatus(),
                        this.checkJellyfinStatus(),
                        this.checkNextcloudStatus(),
                        this.checkOverseerrStatus()
                    ]);
                },

                async checkPlexStatus() {
                    try {
                        const resp = await fetch('/api/plex/status');
                        this.plexStatus = await resp.json();
                    } catch (e) {
                        this.plexStatus = { connected: false, error: 'Failed to check' };
                    }
                },

                async checkOmbiStatus() {
                    try {
                        const resp = await fetch('/api/ombi/status');
                        this.ombiStatus = await resp.json();
                    } catch (e) {
                        this.ombiStatus = { connected: false, error: 'Failed to check' };
                    }
                },

                async checkJellyfinStatus() {
                    try {
                        const resp = await fetch('/api/jellyfin/status');
                        this.jellyfinStatus = await resp.json();
                    } catch (e) {
                        this.jellyfinStatus = { connected: false, error: 'Failed to check' };
                    }
                },

                async checkNextcloudStatus() {
                    try {
                        const resp = await fetch('/api/nextcloud/status');
                        this.nextcloudStatus = await resp.json();
                    } catch (e) {
                        this.nextcloudStatus = { connected: false, error: 'Failed to check' };
                    }
                },

                async checkOverseerrStatus() {
                    try {
                        const resp = await fetch('/api/overseerr/status');
                        this.overseerrStatus = await resp.json();
                    } catch (e) {
                        this.overseerrStatus = { connected: false, error: 'Failed to check' };
                    }
                },

                async addFriend() {
                    if (!this.newFriendName.trim()) return;
                    await fetch('/api/friends', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: this.newFriendName, service_ids: [] })
                    });
                    this.newFriendName = '';
                    await this.loadAdminData();
                },

                async deleteFriend(id) {
                    if (!confirm('Delete this friend?')) return;
                    await fetch(`/api/friends/${id}`, { method: 'DELETE' });
                    await this.loadAdminData();
                },

                async toggleService(friend, service) {
                    const currentIds = friend.services.map(s => s.id);
                    const isAdding = !currentIds.includes(service.id);
                    const newIds = isAdding
                        ? [...currentIds, service.id]
                        : currentIds.filter(id => id !== service.id);

                    const resp = await fetch(`/api/friends/${friend.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ service_ids: newIds })
                    });

                    if (resp.ok) {
                        const data = await resp.json();
                        // Show feedback about account operations
                        if (data.account_operations && data.account_operations.length > 0) {
                            const msgs = data.account_operations.map(op => {
                                if (op.success) {
                                    return `${op.service}: Account ${op.action}`;
                                } else {
                                    return `${op.service}: ${op.error || 'Failed'}`;
                                }
                            });
                            // Brief notification - could use a toast library in future
                            console.log('Account operations:', msgs.join(', '));
                        }
                    }
                    await this.loadAdminData();
                },

                hasService(friend, serviceId) {
                    return friend.services.some(s => s.id === serviceId);
                },

                getSortedServicesForFriend(friend) {
                    // Filter out Homepage (self-referential) and sort:
                    // 1) services friend has access to first, 2) then by stack, 3) then by name
                    return [...this.services]
                        .filter(s => s.name.toLowerCase() !== 'homepage')
                        .sort((a, b) => {
                            const aHasAccess = this.hasService(friend, a.id) ? 0 : 1;
                            const bHasAccess = this.hasService(friend, b.id) ? 0 : 1;
                            if (aHasAccess !== bHasAccess) return aHasAccess - bHasAccess;
                            // Then sort by stack (empty stacks go last)
                            const aStack = a.stack || 'zzz';
                            const bStack = b.stack || 'zzz';
                            if (aStack !== bStack) return aStack.localeCompare(bStack);
                            // Finally by name
                            return a.name.localeCompare(b.name);
                        });
                },

                async toggleServiceVisibility(service) {
                    const resp = await fetch(`/api/services/${service.id}/toggle-visibility`, {
                        method: 'POST'
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        service.visible_to_friends = data.visible_to_friends ? 1 : 0;
                    }
                },

                hasAccount(friend, service) {
                    // Check if friend has an account for this managed service
                    const serviceLower = service.name.toLowerCase();
                    const accountColumns = {
                        'plex': 'plex_user_id',
                        'ombi': 'ombi_user_id',
                        'jellyfin': 'jellyfin_user_id',
                        'nextcloud': 'nextcloud_user_id',
                        'overseerr': 'overseerr_user_id',
                        'jellyseerr': 'jellyseerr_user_id',
                        'mattermost': 'mattermost_user_id',
                        'chat': 'mattermost_user_id',
                    };
                    const col = accountColumns[serviceLower];
                    return col && friend[col] && friend[col] !== '';
                },

                async addServiceToFriend(friend, service) {
                    const key = friend.id + '-' + service.id;
                    if (this.isManagedService(service)) {
                        this.creatingAccount[key] = true;
                    }

                    const currentIds = friend.services.map(s => s.id);
                    const newIds = [...currentIds, service.id];

                    try {
                        const resp = await fetch(`/api/friends/${friend.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ service_ids: newIds })
                        });
                        if (resp.ok) {
                            await this.loadAdminData();
                        }
                    } finally {
                        this.creatingAccount[key] = false;
                    }
                },

                async removeServiceFromFriend(friend, service) {
                    const currentIds = friend.services.map(s => s.id);
                    const newIds = currentIds.filter(id => id !== service.id);

                    const resp = await fetch(`/api/friends/${friend.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ service_ids: newIds })
                    });
                    if (resp.ok) {
                        await this.loadAdminData();
                    }
                },

                async addService() {
                    if (!this.newService.name || !this.newService.url) return;
                    await fetch('/api/services', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newService)
                    });
                    this.newService = { name: '', url: '', icon: '', description: '', subdomain: '', is_default: false, github_repo: '', quick_join_params: '' };
                    await this.loadAdminData();
                    await this.loadCIStatus();
                },

                getStackClass(stack) {
                    const classes = {
                        'media': 'bg-purple-900 text-purple-200',
                        'infra': 'bg-blue-900 text-blue-200',
                        'social': 'bg-green-900 text-green-200',
                        'priorities': 'bg-orange-900 text-orange-200'
                    };
                    return classes[stack] || 'bg-gray-700 text-gray-300';
                },

                getStackActiveClass(stack) {
                    const classes = {
                        'media': 'bg-purple-600 text-white',
                        'infra': 'bg-blue-600 text-white',
                        'social': 'bg-green-600 text-white',
                        'priorities': 'bg-orange-600 text-white'
                    };
                    return classes[stack] || 'bg-blue-600 text-white';
                },

                async deleteService(id) {
                    if (!confirm('Delete this service? It will be removed from all friends.')) return;
                    await fetch(`/api/services/${id}`, { method: 'DELETE' });
                    await this.loadAdminData();
                },

                async loadFriendView(token) {
                    this.friendToken = token;
                    try {
                        const resp = await fetch(`/api/f/${token}`);
                        if (resp.ok) {
                            const data = await resp.json();
                            this.friendId = data.id;
                            this.friendName = data.name;
                            this.friendServices = data.services;
                            this.view = 'friend';
                            // Create a session for cross-subdomain auth
                            await fetch('/api/auth/friend-session', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `token=${encodeURIComponent(token)}`
                            });
                        } else {
                            this.friendError = 'Invalid or expired link';
                            this.view = 'friend';
                        }
                    } catch (e) {
                        this.friendError = 'Failed to load';
                        this.view = 'friend';
                    }
                },

                copyUrl(token) {
                    navigator.clipboard.writeText(`https://${this.baseDomain}/f/${token}`);
                    this.showToast('Link copied!');
                },

                showToast(message, duration = 2000) {
                    this.toast.message = message;
                    this.toast.show = true;
                    setTimeout(() => { this.toast.show = false; }, duration);
                },

                getServiceUrl(service) {
                    // Route services through auth endpoint only if they need special auth handling
                    // jellyfin/ombi/overseerr need API auth, basic needs preauth
                    const authType = service.auth_type || 'none';
                    if (service.subdomain && (authType === 'jellyfin' || authType === 'ombi' || authType === 'basic' || authType === 'overseerr')) {
                        return `/auth/${service.subdomain}`;
                    }

                    // Build URL with quick-join params if configured
                    let url = new URL(service.url);

                    // Apply quick_join_params if present (JSON object with param name -> value)
                    if (service.quick_join_params && this.friendName) {
                        try {
                            const params = JSON.parse(service.quick_join_params);
                            Object.entries(params).forEach(([key, value]) => {
                                // Support template variables
                                let paramValue = value;
                                if (value === '{friendName}') {
                                    paramValue = this.friendName;
                                } else if (value === '{friendToken}') {
                                    paramValue = this.friendToken;
                                }
                                url.searchParams.set(key, paramValue);
                            });
                        } catch (e) {
                            console.error('Invalid quick_join_params JSON:', e);
                        }
                    }

                    // For Jitsi/Video Chat, append friend's name as display name
                    if (service.name.toLowerCase().includes('video') && this.friendName) {
                        url.hash = `userInfo.displayName="${encodeURIComponent(this.friendName)}"`;
                    }

                    return url.toString();
                },

                isAutoAuth(service) {
                    // Determines if a service auto-authenticates (no user intervention needed)
                    // Includes: auto-login services AND services that bypass basic auth (open access)
                    const authType = service.auth_type || '';

                    // Auto-login implementations (cookie proxy and token injection)
                    if (authType === 'jellyfin' || authType === 'ombi' || authType === 'overseerr') {
                        return true;
                    }
                    // Services that bypass basic auth - accessible without login (video chat, freeciv, etc)
                    if (authType === 'forward-auth' || authType === 'open') {
                        return true;
                    }
                    return false;
                },

                needsManualLogin(service) {
                    // Services where we have stored credentials but user must enter them manually
                    // Nextcloud: shows credentials modal for copy/paste
                    // Mattermost-creds: shows credentials modal for Mattermost login
                    // Sonarr-creds: shows credentials modal for both basic auth and Sonarr app login
                    // Basic auth: shows credentials modal for browser basic auth
                    const authType = service.auth_type || '';
                    return authType === 'nextcloud' || authType === 'mattermost-creds' || authType === 'sonarr-creds' || authType === 'basic';
                },

                hasKnownAuthType(service) {
                    // Check if service has a known auth type (for showing/hiding icons)
                    const authType = service.auth_type || '';
                    const knownTypes = ['jellyfin', 'ombi', 'overseerr', 'forward-auth', 'open', 'nextcloud', 'mattermost-creds', 'sonarr-creds', 'basic', 'plex'];
                    return knownTypes.includes(authType);
                },

                getServiceIcon(service) {
                    // Returns {icon, color, title} or null based on service status
                    const healthStatus = this.serviceStatuses[service.id] || {};

                    // Service down = red X (applies to both admin and friend views)
                    if (healthStatus.health === 'down') {
                        return { icon: '‚ùå', color: 'red-400', title: 'service down' };
                    }

                    // Admin view - gear icon (admin uses their own credentials everywhere)
                    if (this.view === 'admin') {
                        return { icon: '‚öôÔ∏è', color: 'blue-400', title: 'admin access' };
                    }

                    // Check if account is being provisioned (for friend view)
                    if (this.friendId) {
                        const serviceKey = service.subdomain || service.name.toLowerCase();
                        const provKey = `${this.friendId}:${serviceKey}`;
                        const provStatus = this.provisioningStatuses[provKey];
                        if (provStatus && provStatus.status === 'provisioning') {
                            return { icon: '‚è≥', color: 'yellow-400', title: 'setting up account...' };
                        }
                    }

                    // Admin always sees arrow for credential-display services (they manage their own sessions)
                    const isAdmin = (this.view === 'admin' || this.view === 'admin-services');

                    // Has basic auth we can't bypass = pencil (credentials in modal)
                    // BUT admins see arrow since they click through directly
                    if (healthStatus.health === 'auth_required' && this.needsManualLogin(service) && !isAdmin) {
                        return { icon: '‚úèÔ∏è', color: 'yellow-400', title: 'credentials in modal' };
                    }

                    // Manual login without health check info
                    // BUT admins see arrow since they click through directly
                    if (this.needsManualLogin(service) && !isAdmin) {
                        return { icon: '‚úèÔ∏è', color: 'yellow-400', title: 'manual login required' };
                    }

                    // Ready: auto-login, open service, or health check passed - arrow means "click to go right in"
                    if (this.isAutoAuth(service) || healthStatus.health === 'up') {
                        return { icon: '‚ÜóÔ∏è', color: 'green-400', title: 'click to enter' };
                    }

                    // External account (like Plex) - key means "use your own account"
                    if (this.hasKnownAuthType(service)) {
                        return { icon: 'üîë', color: 'gray-400', title: 'use your own account' };
                    }

                    return null; // Unknown/no icon
                },

                async handleServiceClick(service) {
                    console.log('handleServiceClick:', service.name, 'auth_type:', service.auth_type, 'needsManualLogin:', this.needsManualLogin(service));

                    // Admin can always click through directly (they manage their own sessions)
                    const isAdmin = (this.view === 'admin' || this.view === 'admin-services');

                    // For services requiring manual login with stored credentials, show modal
                    // BUT: admins skip the credentials modal and go directly to the service
                    if (this.needsManualLogin(service) && !isAdmin) {
                        await this.showCredentialsModal(service);
                    } else {
                        // For auto-auth, external services, or admin access, just navigate
                        window.open(this.getServiceUrl(service), '_blank');
                    }
                },

                async showCredentialsModal(service) {
                    console.log('showCredentialsModal called for:', service.name);
                    this.credentialsService = service;
                    try {
                        // Use different endpoint for admin vs friend
                        const isAdmin = (this.view === 'admin' || this.view === 'admin-services');
                        console.log('Current view:', this.view, 'isAdmin:', isAdmin);
                        const url = isAdmin
                            ? `/api/admin/credentials/${service.subdomain || service.name.toLowerCase()}`
                            : `/api/f/${this.friendToken}/credentials/${service.subdomain || service.name.toLowerCase()}`;
                        console.log('Fetching credentials from:', url);
                        const resp = await fetch(url);
                        console.log('Response status:', resp.status, 'ok:', resp.ok);
                        if (resp.ok) {
                            const data = await resp.json();
                            console.log('Got credentials, setting modal state');
                            this.friendCredentials = { username: data.username, password: data.password };
                            this.showCredentials = true;
                            console.log('Modal should now be visible, showCredentials =', this.showCredentials);
                        } else {
                            console.log('Response not OK, opening service directly');
                            // No stored credentials, just open the service
                            window.open(this.getDirectServiceUrl(service), '_blank');
                        }
                    } catch (e) {
                        console.error('Error in showCredentialsModal:', e);
                        window.open(this.getDirectServiceUrl(service), '_blank');
                    }
                },

                getDirectServiceUrl(service) {
                    if (service?.subdomain) {
                        return `https://${service.subdomain}.${this.baseDomain}`;
                    }
                    return service?.url || '#';
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text);
                    this.showToast('Copied!');
                },

                async copyPreauthUrl(serviceId) {
                    try {
                        const resp = await fetch(`/api/services/${serviceId}/preauth-url`);
                        if (resp.ok) {
                            const data = await resp.json();
                            await navigator.clipboard.writeText(data.url);
                            this.showToast(`Auth URL copied for ${data.service}`);
                        } else {
                            const err = await resp.json();
                            this.showToast(`Error: ${err.detail}`);
                        }
                    } catch (e) {
                        this.showToast('Failed to get pre-auth URL');
                    }
                },

                async toggleServiceDefault(service) {
                    try {
                        const resp = await fetch(`/api/services/${service.id}/toggle-default`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                        if (resp.ok) {
                            await this.loadServices();
                        } else {
                            const err = await resp.json();
                            alert(`Error: ${err.detail}`);
                        }
                    } catch (e) {
                        alert('Failed to toggle default status');
                    }
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString();
                },

                timeAgo(dateStr) {
                    if (!dateStr) return '';
                    // Ensure ISO timestamp has timezone (append 'Z' for UTC if missing)
                    const isoStr = dateStr.includes('Z') || dateStr.includes('+') || dateStr.includes('-', 10)
                        ? dateStr
                        : dateStr + 'Z';
                    const date = new Date(isoStr);
                    const now = new Date();
                    const seconds = Math.floor((now - date) / 1000);

                    // Handle edge cases
                    if (seconds < 0) return 'just now';
                    if (seconds < 10) return 'just now';
                    if (seconds < 60) return seconds + ' seconds ago';

                    const intervals = [
                        { label: 'year', plural: 'years', seconds: 31536000 },
                        { label: 'month', plural: 'months', seconds: 2592000 },
                        { label: 'week', plural: 'weeks', seconds: 604800 },
                        { label: 'day', plural: 'days', seconds: 86400 },
                        { label: 'hour', plural: 'hours', seconds: 3600 },
                        { label: 'minute', plural: 'minutes', seconds: 60 }
                    ];

                    for (const interval of intervals) {
                        const count = Math.floor(seconds / interval.seconds);
                        if (count >= 1) {
                            return count + ' ' + (count === 1 ? interval.label : interval.plural) + ' ago';
                        }
                    }
                    return 'just now';
                },

                getSortedFriends() {
                    return [...this.friends].sort((a, b) => {
                        // First sort by last_visit (most recent first)
                        // Friends with no visit go to the end
                        if (a.last_visit && !b.last_visit) return -1;
                        if (!a.last_visit && b.last_visit) return 1;
                        if (a.last_visit && b.last_visit) {
                            const dateCompare = new Date(b.last_visit) - new Date(a.last_visit);
                            if (dateCompare !== 0) return dateCompare;
                        }
                        // Then sort alphabetically by name
                        return a.name.localeCompare(b.name);
                    });
                },

                // Request access methods
                async loadRequestAccessInfo() {
                    if (!this.requestService) return;
                    try {
                        const resp = await fetch(`/api/request-access-info?service=${this.requestService}`);
                        if (resp.ok) {
                            this.requestInfo = await resp.json();
                        }
                    } catch (e) {
                        console.error('Failed to load request info', e);
                    }
                },

                async submitAccessRequest() {
                    this.requestError = '';
                    try {
                        const resp = await fetch(`/api/access-requests?service=${this.requestService}`, {
                            method: 'POST'
                        });
                        if (resp.ok) {
                            this.requestSubmitted = true;
                        } else {
                            const data = await resp.json();
                            this.requestError = data.detail || 'Request failed';
                        }
                    } catch (e) {
                        this.requestError = 'Request failed';
                    }
                },

                // Admin request methods
                async approveRequest(id) {
                    await fetch(`/api/access-requests/${id}/approve`, { method: 'POST' });
                    await this.loadAdminData();
                },

                async denyRequest(id) {
                    if (!confirm('Deny this request?')) return;
                    await fetch(`/api/access-requests/${id}/deny`, { method: 'POST' });
                    await this.loadAdminData();
                },

                // Service name editing
                startEditName(service) {
                    this.editingNameId = service.id;
                    this.editingName = service.name || '';
                },

                cancelEditName() {
                    this.editingNameId = null;
                    this.editingName = '';
                },

                async saveName(service) {
                    try {
                        const resp = await fetch(`/api/services/${service.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editingName,
                                url: service.url,
                                icon: service.icon,
                                description: service.description || '',
                                display_order: service.display_order || 0,
                                subdomain: service.subdomain || '',
                                stack: service.stack || '',
                                is_default: service.is_default
                            })
                        });
                        if (resp.ok) {
                            this.editingNameId = null;
                            this.editingName = '';
                            await this.loadAdminData();
                        } else {
                            const err = await resp.json();
                            alert(`Error: ${err.detail}`);
                        }
                    } catch (e) {
                        alert('Failed to save name');
                    }
                },

                // Service description editing
                startEditDescription(service) {
                    this.editingServiceId = service.id;
                    this.editingDescription = service.description || '';
                },

                cancelEditDescription() {
                    this.editingServiceId = null;
                    this.editingDescription = '';
                },

                supportsAuthUrl(service) {
                    // Only show "Copy Auth URL" for services where preauth actually works
                    // basic auth via URL is blocked by browsers, so exclude it
                    // jellyfin and ombi have API-based auth
                    const authType = service.auth_type || 'none';
                    return service.subdomain && (authType === 'none' || authType === 'jellyfin' || authType === 'ombi');
                },

                async saveDescription(service) {
                    try {
                        const resp = await fetch(`/api/services/${service.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: service.name,
                                url: service.url,
                                icon: service.icon,
                                description: this.editingDescription,
                                display_order: service.display_order || 0,
                                subdomain: service.subdomain || '',
                                stack: service.stack || '',
                                is_default: service.is_default
                            })
                        });
                        if (resp.ok) {
                            this.editingServiceId = null;
                            this.editingDescription = '';
                            await this.loadAdminData();
                        } else {
                            const err = await resp.json();
                            alert(`Error: ${err.detail}`);
                        }
                    } catch (e) {
                        alert('Failed to save description');
                    }
                },

                // Stack grouping helpers
                getGroupedServices(services) {
                    // Group services by stack
                    const groups = {};
                    const noStack = [];

                    services.forEach(service => {
                        const stack = service.stack || '';
                        if (stack) {
                            if (!groups[stack]) groups[stack] = [];
                            groups[stack].push(service);
                        } else {
                            noStack.push(service);
                        }
                    });

                    // Convert to array with specific order: social, media, other, infra
                    const result = [];
                    const stackOrder = ['social', 'media']; // other and infra handled specially

                    // Add stacks in order (if 2+ services)
                    stackOrder.forEach(stack => {
                        if (groups[stack] && groups[stack].length >= 2) {
                            result.push({ stack, services: groups[stack] });
                        }
                    });

                    // Combine single-item stacks and no-stack items into ungrouped "Other"
                    const ungrouped = [...noStack];
                    Object.keys(groups).forEach(stack => {
                        if (!stackOrder.includes(stack) && stack !== 'infra' && groups[stack].length < 2) {
                            ungrouped.push(...groups[stack]);
                        } else if (stackOrder.includes(stack) && groups[stack].length < 2) {
                            ungrouped.push(...groups[stack]);
                        }
                    });

                    // Add any other stacks not in stackOrder (except infra)
                    Object.keys(groups).forEach(stack => {
                        if (!stackOrder.includes(stack) && stack !== 'infra' && groups[stack].length >= 2) {
                            result.push({ stack, services: groups[stack] });
                        }
                    });

                    if (ungrouped.length > 0) {
                        result.push({ stack: '', services: ungrouped });
                    }

                    // Add Infrastructure last (if 2+ services)
                    if (groups['infra'] && groups['infra'].length >= 2) {
                        result.push({ stack: 'infra', services: groups['infra'] });
                    } else if (groups['infra']) {
                        // Single infra item goes to Other - find and add to it
                        const otherGroup = result.find(g => g.stack === '');
                        if (otherGroup) {
                            otherGroup.services.push(...groups['infra']);
                        } else {
                            result.push({ stack: '', services: groups['infra'] });
                        }
                    }

                    return result;
                },

                getNonDefaultGroupedServices() {
                    // Group non-default services by stack for admin panel
                    const nonDefault = this.services.filter(s => !s.is_default);
                    const groups = {};
                    const noStack = [];

                    nonDefault.forEach(service => {
                        const stack = service.stack || '';
                        if (stack) {
                            if (!groups[stack]) groups[stack] = [];
                            groups[stack].push(service);
                        } else {
                            noStack.push(service);
                        }
                    });

                    // Convert to array - merge single-item groups into "Other"
                    const result = [];
                    const ungrouped = [...noStack];

                    // Sort stacks: alphabetically but exclude 'infra' (added at very end)
                    const sortedStacks = Object.keys(groups)
                        .filter(s => s !== 'infra')
                        .sort();

                    // Add stacks with 2+ services, merge single-item stacks into Other
                    sortedStacks.forEach(stack => {
                        if (groups[stack].length >= 2) {
                            result.push({ stack, services: groups[stack] });
                        } else {
                            ungrouped.push(...groups[stack]);
                        }
                    });

                    // Add "Other" (no stack + single-item stacks)
                    if (ungrouped.length > 0) {
                        result.push({ stack: '', services: ungrouped });
                    }

                    // Add Infrastructure last (only if 2+ services)
                    if (groups['infra'] && groups['infra'].length >= 2) {
                        result.push({ stack: 'infra', services: groups['infra'] });
                    } else if (groups['infra']) {
                        // Single infra item goes to Other
                        const otherGroup = result.find(g => g.stack === '');
                        if (otherGroup) {
                            otherGroup.services.push(...groups['infra']);
                        } else {
                            result.push({ stack: '', services: groups['infra'] });
                        }
                    }

                    return result;
                },

                getStackIcon(stack) {
                    const icons = {
                        'media': 'üé¨',
                        'infra': 'üîß',
                        'games': 'üéÆ',
                        'social': 'üí¨',
                        'priorities': 'üìã'
                    };
                    return icons[stack] || 'üì¶';
                },

                getStackLabel(stack) {
                    const labels = {
                        'media': 'Media',
                        'infra': 'Infrastructure',
                        'games': 'Games',
                        'social': 'Social',
                        'priorities': 'Priorities'
                    };
                    return labels[stack] || stack.charAt(0).toUpperCase() + stack.slice(1);
                },

                // Check if a service has managed integration (auto-account creation)
                isManagedService(service) {
                    const managedServices = ['plex', 'ombi', 'jellyfin', 'nextcloud', 'overseerr', 'mattermost', 'chat'];
                    return managedServices.includes(service.name.toLowerCase());
                },

                // Check if service can auto-create accounts (not just managed, but actually creates accounts)
                canAutoCreateAccount(service) {
                    // Plex is "managed" but doesn't auto-create - user invites themselves via Plex
                    const autoCreateServices = ['ombi', 'jellyfin', 'nextcloud', 'overseerr', 'mattermost', 'chat'];
                    return autoCreateServices.includes(service.name.toLowerCase());
                },

                // Get auth status info for admin view - shows capabilities for new users
                // Returns { icons: string, title: string } or null
                getAuthStatusInfo(service) {
                    const healthStatus = this.serviceStatuses[service.id] || {};
                    const isDown = healthStatus.health === 'down';
                    const canCreate = this.canAutoCreateAccount(service);
                    const isManualLogin = this.needsManualLogin(service);
                    const isAuto = this.isAutoAuth(service);

                    // Build the status
                    let icons = '';
                    let parts = [];

                    // User management capability
                    if (canCreate) {
                        icons += 'üë§';
                        parts.push('auto-provision users');
                    }

                    // Authentication method
                    if (isDown) {
                        icons += '‚ùå';
                        parts.push('service down');
                    } else if (service.auth_type === 'basic') {
                        icons += 'üîí';
                        parts.push('per-user HTTP basic auth');
                    } else if (isManualLogin) {
                        icons += '‚úèÔ∏è';
                        parts.push('manual login with credentials');
                    } else if (isAuto) {
                        icons += '‚ÜóÔ∏è';
                        parts.push('auto-login via session');
                    } else if (service.auth_type === 'plex') {
                        icons += 'üîê';
                        parts.push('Plex managed users');
                    } else if (service.auth_type === 'forward-auth') {
                        icons += 'üé´';
                        parts.push('homepage SSO');
                    } else if (service.auth_type === 'none' || !service.auth_type) {
                        icons += 'üîì';
                        parts.push('no authentication');
                    }

                    // Security status
                    if (service.subdomain) {
                        icons += 'üåê';
                        parts.push(`public (${service.subdomain}.${this.baseDomain})`);
                    } else {
                        icons += 'üè†';
                        parts.push('local only');
                    }

                    // fail2ban protection (basic auth services get fail2ban)
                    if (service.auth_type === 'basic' || service.auth_type === 'forward-auth') {
                        icons += 'üõ°Ô∏è';
                        parts.push('fail2ban protected');
                    }

                    return icons ? { icons, title: parts.join(' | ') } : null;
                },

                // Get comprehensive security description for service detail view
                getSecurityDescription(service) {
                    const canCreate = this.canAutoCreateAccount(service);
                    const isManualLogin = this.needsManualLogin(service);
                    const isAuto = this.isAutoAuth(service);
                    let html = '';

                    // Authentication Method
                    html += '<div><strong class="text-gray-400">Authentication:</strong> ';
                    if (service.auth_type === 'basic') {
                        html += '<span class="text-blue-300">Per-User HTTP Basic Auth</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Each friend gets unique credentials (e.g., annette_sonarr). Admin uses shared credentials.</span>';
                    } else if (service.auth_type === 'forward-auth') {
                        html += '<span class="text-blue-300">Homepage SSO</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Users must log into homepage first, then access is seamless.</span>';
                    } else if (service.auth_type === 'plex') {
                        html += '<span class="text-blue-300">Plex Managed Users</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Friends use Plex managed user accounts with optional PIN.</span>';
                    } else if (service.auth_type === 'jellyfin' || service.auth_type === 'ombi' || service.auth_type === 'overseerr' || service.auth_type === 'jellyseerr') {
                        html += '<span class="text-blue-300">Service-Native Authentication</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Service has built-in user accounts and session management.</span>';
                    } else if (service.auth_type === 'nextcloud' || service.auth_type === 'mattermost-creds') {
                        html += '<span class="text-blue-300">Service-Native (Manual Login)</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Homepage displays credentials, friend logs in manually.</span>';
                    } else {
                        html += '<span class="text-gray-400">None (Public)</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Service is publicly accessible without authentication.</span>';
                    }
                    html += '</div>';

                    // User Management
                    if (canCreate) {
                        html += '<div class="mt-2"><strong class="text-gray-400">User Management:</strong> ';
                        html += '<span class="text-green-300">Auto-Provision</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Homepage automatically creates/deletes user accounts when service is granted/revoked.</span>';
                        html += '</div>';
                    }

                    // Auto-Login Capability
                    if (isAuto) {
                        html += '<div class="mt-2"><strong class="text-gray-400">Login Experience:</strong> ';
                        html += '<span class="text-green-300">Auto-Login</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Friends are automatically logged in when clicking from homepage.</span>';
                        html += '</div>';
                    } else if (service.auth_type === 'basic') {
                        html += '<div class="mt-2"><strong class="text-gray-400">Login Experience:</strong> ';
                        html += '<span class="text-yellow-300">Auto-Inject (with fallback)</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Homepage attempts to inject credentials automatically. If browser blocks, credentials are displayed for manual entry.</span>';
                        html += '</div>';
                    } else if (isManualLogin) {
                        html += '<div class="mt-2"><strong class="text-gray-400">Login Experience:</strong> ';
                        html += '<span class="text-yellow-300">Manual Login</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Homepage displays credentials in a modal. Friend copies and pastes into login form.</span>';
                        html += '</div>';
                    }

                    // Public Exposure
                    html += '<div class="mt-2"><strong class="text-gray-400">Network Exposure:</strong> ';
                    if (service.subdomain) {
                        html += '<span class="text-orange-300">Public</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Accessible at ' + service.subdomain + '.' + this.baseDomain + ' via HTTPS (Let\'s Encrypt SSL).</span>';
                    } else {
                        html += '<span class="text-green-300">Local Only</span><br>';
                        html += '<span class="text-gray-400 text-xs ml-4">Only accessible from localhost or same Docker network. Not exposed to internet.</span>';
                    }
                    html += '</div>';

                    // Security Protections
                    html += '<div class="mt-2"><strong class="text-gray-400">Security Protections:</strong><br>';
                    const protections = [];
                    if (service.auth_type === 'basic' || service.auth_type === 'forward-auth') {
                        protections.push('<span class="text-green-300">üõ°Ô∏è fail2ban</span> - Bans IPs after 5 failed auth attempts');
                    }
                    if (service.subdomain) {
                        protections.push('<span class="text-green-300">üîí HTTPS</span> - All traffic encrypted via SSL/TLS');
                    }
                    if (service.auth_type === 'basic') {
                        protections.push('<span class="text-green-300">üîê Per-User Creds</span> - Individual accountability, easy revocation');
                    }
                    if (service.auth_type !== 'none' && service.auth_type) {
                        protections.push('<span class="text-green-300">üö´ Auth Required</span> - Unauthorized access prevented');
                    }
                    if (!service.subdomain) {
                        protections.push('<span class="text-green-300">üè† Firewall</span> - Not exposed to internet (localhost only)');
                    }

                    if (protections.length > 0) {
                        html += '<span class="text-gray-400 text-xs ml-4">' + protections.join('<br><span class="text-gray-400 text-xs ml-4">') + '</span>';
                    } else {
                        html += '<span class="text-gray-400 text-xs ml-4">None (public service)</span>';
                    }
                    html += '</div>';

                    return html;
                },

                // Load integration status for all managed services
                async loadIntegrationStatus() {
                    try {
                        const resp = await fetch('/api/services/integrations-summary');
                        if (resp.ok) {
                            this.integrationStatus = await resp.json();
                        }
                    } catch (e) {
                        console.error('Failed to load integration status:', e);
                    }
                    // Also load CI status
                    await this.loadCIStatus();
                },

                async loadCIStatus() {
                    try {
                        const resp = await fetch('/api/services/ci-status');
                        if (resp.ok) {
                            this.ciStatus = await resp.json();
                        }
                    } catch (e) {
                        console.error('Failed to load CI status:', e);
                    }
                },

                getCIBadgeClass(serviceId) {
                    const ci = this.ciStatus[serviceId];
                    if (!ci) return 'bg-gray-700 text-gray-400';
                    if (ci.status === 'in_progress') return 'bg-yellow-900 text-yellow-300';
                    if (ci.conclusion === 'success') return 'bg-green-900 text-green-300';
                    if (ci.conclusion === 'failure') return 'bg-red-900 text-red-300';
                    return 'bg-gray-700 text-gray-400';
                },

                getCIBadgeText(serviceId) {
                    const ci = this.ciStatus[serviceId];
                    if (!ci) return '?';
                    if (ci.status === 'in_progress') return '‚è≥';
                    if (ci.conclusion === 'success') return '‚úì';
                    if (ci.conclusion === 'failure') return '‚úó';
                    return '?';
                },

                // Start editing a service - opens modal with all fields
                startEditService(service) {
                    this.editService = { ...service };
                },

                cancelEditService() {
                    this.editService = null;
                },

                async saveEditService() {
                    if (!this.editService) return;
                    try {
                        const resp = await fetch(`/api/services/${this.editService.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editService.name,
                                url: this.editService.url,
                                icon: this.editService.icon || '',
                                description: this.editService.description || '',
                                display_order: this.editService.display_order || 0,
                                subdomain: this.editService.subdomain || '',
                                stack: this.editService.stack || '',
                                is_default: this.editService.is_default || false,
                                auth_type: this.editService.auth_type || 'none',
                                github_repo: this.editService.github_repo || ''
                            })
                        });
                        if (resp.ok) {
                            this.editService = null;
                            await this.loadAdminData();
                            await this.loadCIStatus();
                        } else {
                            const err = await resp.json();
                            alert(`Error: ${err.detail}`);
                        }
                    } catch (e) {
                        alert('Failed to save service');
                    }
                }
            }
        }
    </script>
</body>
</html>
