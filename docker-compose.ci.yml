# CI test environment - isolated containers for integration testing
# Uses separate network and unique project names to avoid production conflicts

services:
  ombi:
    image: linuxserver/ombi:latest
    container_name: ombi-ci-${CI_RUN_ID:-local}
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "${OMBI_PORT:-3580}:3579"  # Dynamic port via CI_RUN_ID for parallel runs
    volumes:
      - ombi-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3579/"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - ci-network
      - shared

  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin-ci-${CI_RUN_ID:-local}
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "${JELLYFIN_PORT:-8196}:8096"
    volumes:
      - jellyfin-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network
      - shared

  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr-ci-${CI_RUN_ID:-local}
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "${OVERSEERR_PORT:-5155}:5055"
    volumes:
      - overseerr-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/api/v1/status"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network
      - shared

  mattermost:
    image: mattermost/mattermost-preview:latest
    container_name: mattermost-ci-${CI_RUN_ID:-local}
    ports:
      - "${MATTERMOST_PORT:-8165}:8065"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network
      - shared

  nextcloud:
    image: linuxserver/nextcloud:latest
    container_name: nextcloud-ci-${CI_RUN_ID:-local}
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "${NEXTCLOUD_PORT:-8186}:443"
    volumes:
      - nextcloud-ci-config:/config
      - nextcloud-ci-data:/data
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost/status.php"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - ci-network
      - shared

volumes:
  ombi-ci-config:
    name: ombi-ci-config-${CI_RUN_ID:-local}
  jellyfin-ci-config:
    name: jellyfin-ci-config-${CI_RUN_ID:-local}
  overseerr-ci-config:
    name: overseerr-ci-config-${CI_RUN_ID:-local}
  nextcloud-ci-config:
    name: nextcloud-ci-config-${CI_RUN_ID:-local}
  nextcloud-ci-data:
    name: nextcloud-ci-data-${CI_RUN_ID:-local}

networks:
  ci-network:
    driver: bridge
    name: blaha-ci-isolated-${CI_RUN_ID:-local}
  # Shared network for runner-container communication
  shared:
    external: true
    name: blaha-ci-shared
