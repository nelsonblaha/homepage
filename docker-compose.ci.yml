# CI test environment - isolated containers for integration testing
# Uses separate network and unique project names to avoid production conflicts

services:
  ombi:
    image: linuxserver/ombi:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "${OMBI_PORT:-3580}:3579"  # Dynamic port via CI_RUN_ID for parallel runs
    volumes:
      - ombi-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3579/"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - ci-network

  jellyfin:
    image: linuxserver/jellyfin:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "8196:8096"  # CI port (production uses 8096)
    volumes:
      - jellyfin-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network

  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "5155:5055"  # CI port (production uses 5055)
    volumes:
      - overseerr-ci-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/api/v1/status"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network

  mattermost:
    image: mattermost/mattermost-preview:latest
    ports:
      - "8165:8065"  # CI port (production uses 8065)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - ci-network

  nextcloud:
    image: linuxserver/nextcloud:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    ports:
      - "8186:443"  # CI port (production uses 8086)
    volumes:
      - nextcloud-ci-config:/config
      - nextcloud-ci-data:/data
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost/status.php"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - ci-network

volumes:
  ombi-ci-config:
    name: ombi-ci-config-${CI_RUN_ID:-local}
  jellyfin-ci-config:
    name: jellyfin-ci-config-${CI_RUN_ID:-local}
  overseerr-ci-config:
    name: overseerr-ci-config-${CI_RUN_ID:-local}
  nextcloud-ci-config:
    name: nextcloud-ci-config-${CI_RUN_ID:-local}
  nextcloud-ci-data:
    name: nextcloud-ci-data-${CI_RUN_ID:-local}

networks:
  ci-network:
    driver: bridge
    name: blaha-ci-isolated-${CI_RUN_ID:-local}
