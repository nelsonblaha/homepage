name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  # Unique project name per run to avoid conflicts
  CI_PROJECT: blaha-ci-${{ github.run_id }}

jobs:
  # Fast Python unit tests (pytest)
  pytest:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: pip install -r requirements-test.txt

      - name: Run pytest unit tests
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
        run: |
          cd app
          pytest ../tests/unit/ -v --tb=short

  # Cypress E2E tests without external dependencies
  cypress-unit:
    runs-on: self-hosted
    # No needs - runs in parallel with pytest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Install Cypress dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 || \
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2

      - name: Kill any stale processes on test ports
        timeout-minutes: 1
        run: |
          # Kill anything using our test ports (from previous runs)
          for port in 5000 8100; do
            echo "Checking port $port..."
            fuser -k $port/tcp 2>/dev/null || true
            pid=$(lsof -t -i:$port 2>/dev/null || true)
            [ -n "$pid" ] && kill -9 $pid 2>/dev/null || true
          done
          sleep 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install app dependencies
        run: pip install -r requirements.txt

      - name: Start application
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          DB_PATH: /tmp/test-unit-${{ github.run_id }}.db
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
        run: |
          cd app
          python -m uvicorn main:app --host 0.0.0.0 --port 5000 &
          sleep 5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Cypress
        run: npm ci

      - name: Run unit tests
        run: npx cypress run --spec "cypress/e2e/*.cy.js"
        env:
          CYPRESS_BASE_URL: http://localhost:5000
          CYPRESS_ADMIN_PASSWORD: testpassword

      - name: Stop application
        if: always()
        run: pkill -f "uvicorn main:app" || true

  # Integration tests with real containers (Ombi, etc.)
  integration-tests:
    runs-on: self-hosted
    # No needs - runs in parallel with pytest and cypress-unit
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Install Cypress dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 || \
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2

      - name: Kill any stale processes on test ports
        timeout-minutes: 1
        run: |
          # Kill anything using our test ports (from previous runs)
          for port in 5000 8100; do
            echo "Checking port $port..."
            fuser -k $port/tcp 2>/dev/null || true
            pid=$(lsof -t -i:$port 2>/dev/null || true)
            [ -n "$pid" ] && kill -9 $pid 2>/dev/null || true
          done
          sleep 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python test dependencies
        run: pip install requests

      - name: Cleanup any previous CI containers
        run: |
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml down -v --remove-orphans 2>/dev/null || true

      - name: Start test containers
        env:
          CI_RUN_ID: ${{ github.run_id }}
        run: |
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml up -d ombi
          echo "Waiting for Ombi to become healthy..."

      - name: Wait for Ombi API
        run: |
          # Use Docker bridge gateway IP to reach host services from containerized runner
          OMBI_HOST="${DOCKER_HOST_IP:-172.17.0.1}"
          echo "Waiting for Ombi API to be ready at $OMBI_HOST:3580..."
          for i in $(seq 1 120); do
            # Use /api/v1/Status - it's public and returns 200 when ready
            if curl -s "http://$OMBI_HOST:3580/api/v1/Status" | grep -q "200"; then
              echo "Ombi API is ready after $i attempts"
              exit 0
            fi
            echo "Attempt $i/120 - Ombi API not ready yet..."
            sleep 5
          done
          echo "ERROR: Ombi API failed to start after 10 minutes"
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml logs ombi
          exit 1

      - name: Setup Ombi for CI
        id: ombi-setup
        env:
          OMBI_URL: http://172.17.0.1:3580
        run: |
          chmod +x scripts/setup-ombi-ci.py
          python scripts/setup-ombi-ci.py
          if [ -f /tmp/ombi-api-key.txt ]; then
            echo "OMBI_API_KEY=$(cat /tmp/ombi-api-key.txt)" >> $GITHUB_OUTPUT
          fi

      - name: Start blaha-homepage with Ombi config
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          DB_PATH: /tmp/test-integration-${{ github.run_id }}.db
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
          OMBI_URL: http://172.17.0.1:3580
          OMBI_API_KEY: ${{ steps.ombi-setup.outputs.OMBI_API_KEY }}
        run: |
          pip install -r requirements.txt
          cd app
          python -m uvicorn main:app --host 0.0.0.0 --port 8100 &
          sleep 5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Cypress
        run: npm ci

      - name: Run Ombi integration tests
        run: npx cypress run --spec "cypress/e2e/integration/ombi.cy.js"
        env:
          CYPRESS_BASE_URL: http://localhost:8100
          CYPRESS_ADMIN_PASSWORD: testpassword
          CYPRESS_OMBI_URL: http://172.17.0.1:3580
          CYPRESS_OMBI_API_KEY: ${{ steps.ombi-setup.outputs.OMBI_API_KEY }}

      - name: Cleanup
        if: always()
        run: |
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml down -v --remove-orphans || true
          pkill -f "uvicorn main:app" || true
          rm -f /tmp/test-integration-${{ github.run_id }}.db /tmp/test-unit-${{ github.run_id }}.db

  deploy:
    needs: [pytest, cypress-unit, integration-tests]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to production
        env:
          # Set DEPLOY_PATH in your runner environment or GitHub secrets
          # Example: DEPLOY_PATH=/opt/blaha-homepage
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH || github.workspace }}
        run: |
          cd "$DEPLOY_PATH"
          git pull origin main || true
          docker compose down
          docker compose up -d --build
