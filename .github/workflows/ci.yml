name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  # Unique project name per run to avoid conflicts
  CI_PROJECT: homepage-ci-${{ github.run_id }}
  # Production deploy path (customize for your server)
  DEPLOY_PATH: /home/ben/docker/blaha-homepage

jobs:
  # Fast Python unit tests (pytest)
  pytest:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: pip install -r requirements-test.txt

      - name: Run pytest unit tests with coverage
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
        run: |
          cd app
          pytest ../tests/unit/ -v --tb=short --cov=. --cov-report=term-missing --cov-fail-under=50

  # Cypress E2E tests without external dependencies
  cypress-unit:
    runs-on: self-hosted
    # No needs - runs in parallel with pytest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Install Cypress dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 || \
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2

      - name: Kill any stale processes on test ports
        timeout-minutes: 1
        run: |
          # Kill anything using our test ports (from previous runs)
          for port in 5000 8100; do
            echo "Checking port $port..."
            fuser -k $port/tcp 2>/dev/null || true
            pid=$(lsof -t -i:$port 2>/dev/null || true)
            [ -n "$pid" ] && kill -9 $pid 2>/dev/null || true
          done
          sleep 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install app dependencies
        run: pip install -r requirements.txt

      - name: Start application
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          DB_PATH: /tmp/test-unit-${{ github.run_id }}.db
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
        run: |
          cd app
          python -m uvicorn main:app --host 0.0.0.0 --port 5000 &
          sleep 5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Cypress
        run: npm ci

      - name: Run unit tests
        run: npx cypress run --spec "cypress/e2e/*.cy.js"
        env:
          CYPRESS_BASE_URL: http://localhost:5000
          CYPRESS_ADMIN_PASSWORD: testpassword

      - name: Stop application
        if: always()
        run: pkill -f "uvicorn main:app" || true

  # Integration tests with real containers (Ombi, etc.)
  integration-tests:
    runs-on: self-hosted
    # No needs - runs in parallel with pytest and cypress-unit
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set dynamic port
        id: ports
        run: |
          # Unique port based on run_id to avoid conflicts (3580-4579)
          OMBI_PORT=$(((${{ github.run_id }} % 1000) + 3580))
          echo "OMBI_PORT=$OMBI_PORT" >> $GITHUB_ENV
          echo "ombi_port=$OMBI_PORT" >> $GITHUB_OUTPUT
          echo "Using OMBI_PORT=$OMBI_PORT"

      - name: Install Cypress dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 || \
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2

      - name: Kill any stale processes on test ports
        timeout-minutes: 1
        run: |
          # Kill anything using our test ports (from previous runs)
          for port in 5000 8100; do
            echo "Checking port $port..."
            fuser -k $port/tcp 2>/dev/null || true
            pid=$(lsof -t -i:$port 2>/dev/null || true)
            [ -n "$pid" ] && kill -9 $pid 2>/dev/null || true
          done
          sleep 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python test dependencies
        run: pip install requests

      - name: Cleanup any previous CI containers
        run: |
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml down -v --remove-orphans 2>/dev/null || true

      - name: Start test containers
        env:
          CI_RUN_ID: ${{ github.run_id }}
          OMBI_PORT: ${{ env.OMBI_PORT }}
        run: |
          echo "Starting Ombi on port $OMBI_PORT..."
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml up -d ombi
          echo "Waiting for Ombi to become healthy..."

      - name: Wait for Ombi API
        env:
          CI_RUN_ID: ${{ github.run_id }}
        run: |
          # Use container name on shared network for runner-to-container communication
          OMBI_CONTAINER="ombi-ci-$CI_RUN_ID"
          OMBI_PORT=3579  # Internal port, accessed via shared network

          echo "Waiting for Ombi container $OMBI_CONTAINER to be ready..."

          # First verify container is running
          docker ps | grep "$OMBI_CONTAINER" || echo "WARNING: Container $OMBI_CONTAINER not found!"

          for i in $(seq 1 60); do
            # Access Ombi via container name on shared network (internal port 3579)
            if curl -s --max-time 5 "http://$OMBI_CONTAINER:$OMBI_PORT/api/v1/Status" | grep -q "200"; then
              echo "Ombi API is ready after $i attempts"
              echo "OMBI_CONTAINER=$OMBI_CONTAINER" >> $GITHUB_ENV
              exit 0
            fi
            echo "Attempt $i/60 - Ombi API not ready yet..."
            sleep 2
          done
          echo "ERROR: Ombi API failed to start after 2 minutes"
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml logs ombi
          exit 1

      - name: Setup Ombi for CI
        id: ombi-setup
        env:
          OMBI_URL: http://${{ env.OMBI_CONTAINER }}:3579
        run: |
          chmod +x scripts/setup-ombi-ci.py
          python scripts/setup-ombi-ci.py
          if [ -f /tmp/ombi-api-key.txt ]; then
            echo "OMBI_API_KEY=$(cat /tmp/ombi-api-key.txt)" >> $GITHUB_OUTPUT
          fi

      - name: Start blaha-homepage with Ombi config
        env:
          ADMIN_PASSWORD: testpassword
          SESSION_SECRET: testsecret1234567890abcdef
          DB_PATH: /tmp/test-integration-${{ github.run_id }}.db
          BASE_DOMAIN: localhost
          COOKIE_DOMAIN: ""
          OMBI_URL: http://${{ env.OMBI_CONTAINER }}:3579
          OMBI_API_KEY: ${{ steps.ombi-setup.outputs.OMBI_API_KEY }}
        run: |
          pip install -r requirements.txt
          cd app
          python -m uvicorn main:app --host 0.0.0.0 --port 8100 &
          sleep 5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Cypress
        run: npm ci

      - name: Run Ombi integration tests
        run: npx cypress run --spec "cypress/e2e/integration/ombi.cy.js"
        env:
          CYPRESS_BASE_URL: http://localhost:8100
          CYPRESS_ADMIN_PASSWORD: testpassword
          CYPRESS_OMBI_URL: http://${{ env.OMBI_CONTAINER }}:3579
          CYPRESS_OMBI_API_KEY: ${{ steps.ombi-setup.outputs.OMBI_API_KEY }}

      - name: Cleanup
        if: always()
        env:
          CI_RUN_ID: ${{ github.run_id }}
        run: |
          docker compose -p $CI_PROJECT -f docker-compose.ci.yml down -v --remove-orphans || true
          docker network rm blaha-ci-isolated-${{ github.run_id }} 2>/dev/null || true
          # Clean up CI-specific volumes
          docker volume rm ombi-ci-config-${{ github.run_id }} 2>/dev/null || true
          pkill -f "uvicorn main:app" || true
          rm -f /tmp/test-integration-${{ github.run_id }}.db /tmp/test-unit-${{ github.run_id }}.db

  deploy:
    needs: [pytest, cypress-unit, integration-tests]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Deploy to production
        run: |
          cd $DEPLOY_PATH

          # Mark directory as safe (runner user differs from owner)
          git config --global --add safe.directory $DEPLOY_PATH

          # Pull latest code using HTTPS with GitHub token (SSH not available in container)
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
          git fetch origin main
          git reset --hard origin/main

          # Restore SSH remote URL for local use
          git remote set-url origin git@github.com:${{ github.repository }}.git

          # Rebuild and restart containers
          docker compose down
          docker compose up -d --build
          echo "Deploy complete!"
